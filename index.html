<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Application Settings</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        // Tailwind Configuration
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "card-light": "#ffffff",
                        "card-dark": "#1b2734",
                        "accent-red": "#ef4444",
                        "accent-green": "#10b981",
                        "accent-blue": "#3b82f6",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
        }
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
        /* Custom toggle switch styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: theme('colors.slate.300');
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: theme('colors.primary');
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200 flex flex-col min-h-screen">

    <!-- Confirmation Modal (Hidden by default) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-card-light dark:bg-card-dark rounded-xl p-6 shadow-2xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-3 text-accent-red">Confirm Action</h3>
            <p id="modal-text" class="text-sm text-slate-600 dark:text-slate-300 mb-6">Are you sure you want to delete ALL assignments saved in your browser's Local Storage? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 text-sm font-medium rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600">Cancel</button>
                <button id="modal-confirm" class="px-4 py-2 text-sm font-medium rounded-lg bg-accent-red text-white hover:bg-red-600">Clear Data</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-card-light dark:bg-card-dark sticky top-0 z-10 shadow-md border-b border-slate-200 dark:border-slate-700">
        <div class="p-4 flex items-center justify-between">
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">Settings</h1>
        </div>
    </header>

    <!-- Message Box for Feedback -->
    <div id="message-box" class="mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 p-4 overflow-y-auto space-y-6">

        <!-- Appearance Settings -->
        <section class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-lg space-y-4">
            <h2 class="text-lg font-bold text-primary border-b border-slate-200 dark:border-slate-700 pb-2">Appearance</h2>
            <div class="flex items-center justify-between">
                <p class="text-slate-700 dark:text-slate-200">Dark Mode</p>
                <label class="switch">
                    <!-- The toggle input -->
                    <input type="checkbox" id="dark-mode-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </section>

        <!-- Account & Status -->
        <section class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-lg space-y-4">
            <h2 class="text-lg font-bold text-primary border-b border-slate-200 dark:border-slate-700 pb-2">Account & Status</h2>
            
            <div class="space-y-2">
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Current User ID</p>
                <p id="user-id-display" class="font-mono text-xs p-2 rounded bg-slate-200 dark:bg-slate-700 break-all">Loading...</p>
            </div>
            
            <div class="space-y-2">
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Connection Mode</p>
                <p id="connection-mode-display" class="text-sm font-semibold p-2 rounded bg-slate-200 dark:bg-slate-700">Checking...</p>
            </div>
        </section>

        <!-- Data Management -->
        <section class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-lg space-y-4">
            <h2 class="text-lg font-bold text-primary border-b border-slate-200 dark:border-slate-700 pb-2">Data Management</h2>

            <p class="text-sm text-slate-600 dark:text-slate-300">If you are in Local Mode, your data is saved only in this browser. Use the button below to permanently clear all assignments from your browser's local storage.</p>
            
            <button id="clear-local-data-button" class="w-full flex items-center justify-center p-3 bg-accent-red text-white font-medium rounded-lg shadow-md hover:bg-red-600 transition-colors disabled:opacity-50" disabled>
                <span class="material-symbols-outlined mr-2">delete_forever</span>
                Clear Local Assignments
            </button>
        </section>

    </main>

    <!-- Footer Navigation (Consistent with other pages) -->
    <footer class="bg-card-light dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 sticky bottom-0 z-10">
        <nav class="flex justify-around p-2">
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="dashboard.html">
                <span class="material-symbols-outlined">home</span>
                <span class="text-xs font-medium">Dashboard</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="assignments.html">
                <span class="material-symbols-outlined">list_alt</span>
                <span class="text-xs font-medium">Assignments</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="index.html">
                <span class="material-symbols-outlined">calendar_month</span>
                <span class="text-xs font-medium">Calendar</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-primary w-1/4" href="settings.html">
                <span class="material-symbols-outlined">settings</span>
                <span class="text-xs font-medium">Settings</span>
            </a>
        </nav>
    </footer>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let isLocalMode = false;
        const LOCAL_STORAGE_KEY = `academicPlanner_assignments_${appId}`;

        // UI elements
        const userIdDisplay = document.getElementById('user-id-display');
        const connectionModeDisplay = document.getElementById('connection-mode-display');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const clearLocalDataButton = document.getElementById('clear-local-data-button');
        const modal = document.getElementById('confirmation-modal');
        const modalConfirmButton = document.getElementById('modal-confirm');
        const modalCancelButton = document.getElementById('modal-cancel');

        /**
         * Utility function to display messages.
         */
        function showMessage(message, type, duration = 3000) {
            const messageBox = document.getElementById('message-box');
            let bgColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 dark:bg-green-900';
                    textColor = 'text-green-700 dark:text-green-300';
                    break;
                case 'error':
                    bgColor = 'bg-red-100 dark:bg-red-900';
                    textColor = 'text-red-700 dark:text-red-300';
                    break;
                case 'info':
                    bgColor = 'bg-blue-100 dark:bg-blue-900';
                    textColor = 'text-blue-700 dark:text-blue-300';
                    break;
                default:
                    bgColor = 'bg-gray-100 dark:bg-gray-700';
                    textColor = 'text-gray-800 dark:text-gray-200';
            }

            messageBox.className = `block mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 ${bgColor} ${textColor}`;
            messageBox.innerHTML = message;
            messageBox.classList.remove('hidden');

            if (duration > 0) {
                setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                    setTimeout(() => messageBox.classList.add('hidden', 'opacity-100'), 300);
                }, duration);
            }
        }

        /* --- DARK MODE LOGIC --- */

        /**
         * Applies the dark mode class to the HTML element.
         */
        function applyDarkMode(enabled) {
            if (enabled) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('darkMode', 'enabled');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        darkModeToggle.addEventListener('change', (e) => {
            applyDarkMode(e.target.checked);
        });

        // Initialize dark mode state
        // This runs immediately to set the correct theme and toggle state on load
        if (localStorage.getItem('darkMode') === 'enabled') {
            applyDarkMode(true);
            darkModeToggle.checked = true;
        } else {
            applyDarkMode(false);
            darkModeToggle.checked = false;
        }

        /* --- DATA MANAGEMENT LOGIC --- */

        /**
         * Clears all assignments from local storage.
         */
        function clearLocalAssignments() {
            if (isLocalMode) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                showMessage("Local assignments cleared successfully.", "success");
                
                // Disable the button temporarily and re-enable after a brief delay
                clearLocalDataButton.disabled = true;
                setTimeout(() => clearLocalDataButton.disabled = false, 1000); 

            } else {
                // Should only be callable in local mode, but good to check
                showMessage("Cannot clear local data in Database mode.", "error");
            }
        }

        // Modal event handlers
        clearLocalDataButton.onclick = () => {
            if (isLocalMode) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                 showMessage("Local data clearing is only possible when the app is running in Local Mode.", "info");
            }
        };

        modalConfirmButton.onclick = () => {
            clearLocalAssignments();
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        modalCancelButton.onclick = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };


        /* --- INITIALIZATION --- */

        /**
         * Initializes Firebase or falls back to Local Mode.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                isLocalMode = true;
                console.warn("Firebase configuration missing. Switching to Local Mode.");
                connectionModeDisplay.textContent = 'Local Storage (Fallback)';
                connectionModeDisplay.classList.add('bg-orange-200', 'text-orange-800', 'dark:bg-orange-800', 'dark:text-orange-200');
                userIdDisplay.textContent = 'N/A (Local Mode)';
                clearLocalDataButton.disabled = false;
                showMessage("Database connection missing. Using Local Storage.", "info", 5000);
            } else {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    const auth = getAuth(app);
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    const userId = auth.currentUser?.uid || 'Anonymous';
                    userIdDisplay.textContent = userId;
                    connectionModeDisplay.textContent = 'Database (Firebase Firestore)';
                    connectionModeDisplay.classList.add('bg-green-200', 'text-green-800', 'dark:bg-green-800', 'dark:text-green-200');

                    // If we connect to Firebase, the Clear Local Data button should be disabled
                    clearLocalDataButton.disabled = true;
                    
                    console.log("Firebase initialized and running.");
                    
                } catch (error) {
                    console.error("Firebase initialization failed, falling back to Local Mode:", error);
                    isLocalMode = true;
                    userIdDisplay.textContent = 'ANON_FAIL (Local Mode)';
                    connectionModeDisplay.textContent = 'Local Storage (Fallback)';
                    connectionModeDisplay.classList.add('bg-orange-200', 'text-orange-800', 'dark:bg-orange-800', 'dark:text-orange-200');
                    clearLocalDataButton.disabled = false;
                    showMessage("Database connection failed. Data will use Local Storage.", "info", 5000);
                }
            }
        }
        
        // Initialize the app on load
        initializeFirebase();

    </script>
</body>
</html>
