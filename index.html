<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Academic Calendar</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        // Tailwind Configuration
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "card-light": "#ffffff",
                        "card-dark": "#1b2734",
                        "accent-red": "#ef4444",
                        "accent-green": "#10b981",
                        "accent-blue": "#3b82f6",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
        }
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
        /* Style for the calendar days grid */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: theme('colors.slate.300'); /* Separator color */
            border: 1px solid theme('colors.slate.300');
            border-radius: theme('borderRadius.lg');
            overflow: hidden;
        }
        .day-label {
            @apply text-center text-xs font-semibold py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300;
        }
        .calendar-day {
            @apply relative min-h-[100px] p-2 text-sm bg-card-light dark:bg-card-dark transition-all duration-100 hover:shadow-inner cursor-pointer;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .calendar-day.inactive {
            @apply bg-slate-50 dark:bg-slate-800 text-slate-400 dark:text-slate-500 cursor-default;
        }
        .current-day-number {
            @apply font-bold bg-primary text-white h-6 w-6 rounded-full flex items-center justify-center -translate-x-1;
        }
        .day-number {
            @apply font-medium text-slate-800 dark:text-slate-200 h-6 w-6 flex items-center justify-center -translate-x-1;
        }
        .event-marker {
            @apply text-white text-[10px] px-1.5 py-[1px] rounded-full mt-1 font-medium truncate w-full;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200 flex flex-col min-h-screen">

    <!-- Assignment Details Modal (Hidden by default) -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-card-light dark:bg-card-dark rounded-xl p-6 shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold">Assignments Due</h3>
                <button id="close-modal" class="text-slate-500 dark:text-slate-400 hover:text-primary transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="modal-date" class="text-sm text-primary mb-4 font-medium"></div>
            <div id="modal-events-list" class="space-y-3 max-h-80 overflow-y-auto">
                <!-- Event cards go here -->
            </div>
            <p id="no-events-message" class="text-center text-slate-500 dark:text-slate-400 py-4 hidden">No assignments due on this date.</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-card-light dark:bg-card-dark sticky top-0 z-10 shadow-md border-b border-slate-200 dark:border-slate-700">
        <div class="p-4 flex items-center justify-between">
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">Academic Calendar</h1>
            <a href="add-assignments.html" class="p-2 text-primary hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors">
                <span class="material-symbols-outlined text-2xl">add_circle</span>
            </a>
        </div>
        <!-- Calendar Controls -->
        <div class="flex justify-between items-center p-3 border-t border-slate-200 dark:border-slate-700">
            <button id="prev-month" class="p-2 text-primary hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                <span class="material-symbols-outlined">chevron_left</span>
            </button>
            <h2 id="current-month" class="text-lg font-bold">Loading...</h2>
            <button id="next-month" class="p-2 text-primary hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                <span class="material-symbols-outlined">chevron_right</span>
            </button>
        </div>
    </header>

    <!-- Message Box for Feedback -->
    <div id="message-box" class="mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 hidden"></div>

    <!-- Main Content: Calendar Grid -->
    <main class="flex-1 p-4 overflow-y-auto space-y-4">
        <div id="calendar-wrapper" class="rounded-xl shadow-xl">
            <!-- Day Labels -->
            <div class="grid grid-cols-7 gap-1">
                <div class="day-label">SUN</div>
                <div class="day-label">MON</div>
                <div class="day-label">TUE</div>
                <div class="day-label">WED</div>
                <div class="day-label">THU</div>
                <div class="day-label">FRI</div>
                <div class="day-label">SAT</div>
            </div>
            <!-- Calendar Grid -->
            <div id="calendar-grid">
                <!-- Days will be rendered here -->
            </div>
        </div>
    </main>

    <!-- Footer Navigation (Consistent with other pages) -->
    <footer class="bg-card-light dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 sticky bottom-0 z-10">
        <nav class="flex justify-around p-2">
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="dashboard.html">
                <span class="material-symbols-outlined">home</span>
                <span class="text-xs font-medium">Dashboard</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="assignments.html">
                <span class="material-symbols-outlined">list_alt</span>
                <span class="text-xs font-medium">Assignments</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-primary w-1/4" href="index.html">
                <span class="material-symbols-outlined">calendar_month</span>
                <span class="text-xs font-medium">Calendar</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="settings.html">
                <span class="material-symbols-outlined">settings</span>
                <span class="text-xs font-medium">Settings</span>
            </a>
        </nav>
    </footer>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let isAuthReady = false;
        let isLocalMode = false;
        const LOCAL_STORAGE_KEY = `academicPlanner_assignments_${appId}`;
        let currentAssignments = [];
        let displayDate = new Date(); // Date currently displayed by the calendar

        // UI elements
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthDisplay = document.getElementById('current-month');
        const prevMonthButton = document.getElementById('prev-month');
        const nextMonthButton = document.getElementById('next-month');
        const eventModal = document.getElementById('event-modal');
        const closeModalButton = document.getElementById('close-modal');
        const modalDate = document.getElementById('modal-date');
        const modalEventsList = document.getElementById('modal-events-list');
        const noEventsMessage = document.getElementById('no-events-message');

        // Constants
        const PRIORITY_COLOR_MAP = {
            'High': 'bg-red-500',
            'Medium': 'bg-orange-500',
            'Low': 'bg-slate-500',
        };
        const DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];


        /**
         * Utility function to display messages. (Reused from previous files)
         */
        function showMessage(message, type, duration = 3000) {
            const messageBox = document.getElementById('message-box');
            let bgColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 dark:bg-green-900';
                    textColor = 'text-green-700 dark:text-green-300';
                    break;
                case 'error':
                    bgColor = 'bg-red-100 dark:bg-red-900';
                    textColor = 'text-red-700 dark:text-red-300';
                    break;
                case 'info':
                    bgColor = 'bg-blue-100 dark:bg-blue-900';
                    textColor = 'text-blue-700 dark:text-blue-300';
                    break;
                default:
                    bgColor = 'bg-gray-100 dark:bg-gray-700';
                    textColor = 'text-gray-800 dark:text-gray-200';
            }

            messageBox.className = `block mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 ${bgColor} ${textColor}`;
            messageBox.innerHTML = message;
            messageBox.classList.remove('hidden');

            if (duration > 0) {
                setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                    setTimeout(() => messageBox.classList.add('hidden', 'opacity-100'), 300);
                }, duration);
            }
        }

        /* --- LOCAL STORAGE FUNCTIONS --- */

        /**
         * Reads all assignments from local storage.
         */
        function getAssignmentsFromLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Error reading from local storage:", error);
                return [];
            }
        }
        
        /**
         * Saves the entire assignments array back to local storage.
         */
        function saveAssignmentsToLocal(assignments) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(assignments));
            } catch (error) {
                console.error("Error writing to local storage:", error);
                showMessage("Warning: Failed to save changes locally.", "error");
            }
        }

        /**
         * Local Mode Realtime Listener (simple manual refresh)
         */
        function startLocalModeListener() {
            currentAssignments = getAssignmentsFromLocal();
            renderCalendar();
        }

        /* --- FIREBASE FUNCTIONS --- */

        /**
         * Sets up the real-time listener for Firestore assignments.
         */
        function startFirestoreListener() {
            const assignmentsCol = collection(db, `artifacts/${appId}/public/data/assignments`);

            onSnapshot(assignmentsCol, (snapshot) => {
                currentAssignments = [];
                snapshot.forEach(doc => {
                    currentAssignments.push({ id: doc.id, ...doc.data() });
                });
                renderCalendar();
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                showMessage("Error loading data from database.", "error");
            });
        }
        
        /**
         * Toggles completion status in Firestore Mode.
         */
        async function toggleCompletionFirestore(assignmentId, newStatus) {
            try {
                const { updateDoc, doc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const assignmentRef = doc(db, `artifacts/${appId}/public/data/assignments`, assignmentId);
                await updateDoc(assignmentRef, { isCompleted: newStatus });
                showMessage(`Assignment marked as ${newStatus ? 'Complete' : 'Incomplete'} (DB update).`, 'success');
            } catch (error) {
                console.error("Firestore update error:", error);
                showMessage("Failed to update assignment status.", "error");
            }
        }

        /* --- CALENDAR RENDERING LOGIC --- */

        /**
         * Renders the calendar grid for the currently displayed month.
         */
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            
            const year = displayDate.getFullYear();
            const month = displayDate.getMonth();
            
            // Set the month header
            currentMonthDisplay.textContent = displayDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long' });

            // 1. Get first day of the month (0 = Sun, 6 = Sat)
            const firstDayOfMonth = new Date(year, month, 1).getDay();

            // 2. Get number of days in the month
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // 3. Get today's date for highlighting
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            // 4. Map assignments to dates for quick lookup
            const assignmentsByDate = groupAssignmentsByDate(currentAssignments);
            
            let dayCount = 1;
            let totalDaysRendered = 0;

            // Helper function to get the number of days in the previous month
            const daysInPreviousMonth = new Date(year, month, 0).getDate();
            
            // Helper to format date key for lookup
            const getFormattedDateKey = (year, month, day) => {
                // Ensure month and day are padded with leading zero
                const m = String(month + 1).padStart(2, '0');
                const d = String(day).padStart(2, '0');
                return `${year}-${m}-${d}`;
            };


            // RENDER DAYS
            
            // Loop for weeks (max 6 weeks)
            for (let i = 0; i < 6; i++) {
                // Loop for 7 days in a week
                for (let j = 0; j < 7; j++) {
                    totalDaysRendered++;
                    
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';

                    let dayNumber, dateKey;
                    let isInactive = false;
                    let isToday = false;
                    
                    if (totalDaysRendered <= firstDayOfMonth) {
                        // Previous month's days (Inactive)
                        dayNumber = daysInPreviousMonth - firstDayOfMonth + totalDaysRendered;
                        isInactive = true;
                        dayElement.classList.add('inactive');
                        
                        // Set the dateKey to the actual day in the previous month (for visual continuity)
                        const prevMonth = month === 0 ? 11 : month - 1;
                        const prevYear = month === 0 ? year - 1 : year;
                        dateKey = getFormattedDateKey(prevYear, prevMonth, dayNumber);
                        
                    } else if (dayCount <= daysInMonth) {
                        // Current month's days (Active)
                        dayNumber = dayCount;
                        dateKey = getFormattedDateKey(year, month, dayNumber);
                        
                        // Check if it is today
                        if (isCurrentMonth && dayNumber === today.getDate()) {
                            isToday = true;
                        }

                        // Attach event listener for modal
                        dayElement.onclick = () => openEventModal(dateKey);
                        
                        dayCount++;
                        
                    } else {
                        // Next month's days (Inactive)
                        dayNumber = dayCount - daysInMonth;
                        isInactive = true;
                        dayElement.classList.add('inactive');
                        
                        // Set the dateKey to the actual day in the next month
                        const nextMonth = month === 11 ? 0 : month + 1;
                        const nextYear = month === 11 ? year + 1 : year;
                        dateKey = getFormattedDateKey(nextYear, nextMonth, dayNumber);

                        dayCount++;

                        // Stop if we have passed the 6th row and are on the first day of the next month
                        if (i >= 5 && j === 0) break;
                    }

                    // Render Day Number
                    const numberSpan = document.createElement('span');
                    numberSpan.className = isToday ? 'current-day-number' : 'day-number';
                    numberSpan.textContent = dayNumber;
                    dayElement.appendChild(numberSpan);

                    // Render Events
                    const events = assignmentsByDate[dateKey] || [];
                    
                    // Filter out completed for visualization, but show them in the modal
                    const visibleEvents = events.filter(e => !e.isCompleted);

                    // Sort events by priority (High first)
                    visibleEvents.sort((a, b) => {
                        return (b.priority === 'High' ? 3 : b.priority === 'Medium' ? 2 : 1) - 
                               (a.priority === 'High' ? 3 : a.priority === 'Medium' ? 2 : 1);
                    });

                    // Only show up to 3 events directly on the calendar cell
                    visibleEvents.slice(0, 3).forEach(event => {
                        const marker = document.createElement('div');
                        const priorityClass = (PRIORITY_COLOR_MAP[event.priority] || 'bg-slate-500');
                        marker.className = `event-marker ${priorityClass}`;
                        marker.textContent = `${event.course}: ${event.title}`;
                        dayElement.appendChild(marker);
                    });

                    // If there are more events, add a summary marker
                    if (visibleEvents.length > 3) {
                        const marker = document.createElement('div');
                        marker.className = 'event-marker bg-slate-400 dark:bg-slate-500';
                        marker.textContent = `+${visibleEvents.length - 3} more...`;
                        dayElement.appendChild(marker);
                    }
                    
                    calendarGrid.appendChild(dayElement);
                    
                    // Break outer loop if all days (including filler days) have been rendered or we passed the days of the current month
                    if (dayCount > daysInMonth && j === 6) break; 
                }
                if (dayCount > daysInMonth) break;
            }
        }
        
        /**
         * Groups assignments by their due date for easy calendar mapping.
         * Returns an object where keys are YYYY-MM-DD strings.
         */
        function groupAssignmentsByDate(assignments) {
            const grouped = {};
            assignments.forEach(a => {
                const datePart = a.dueDate; // YYYY-MM-DD format
                if (!grouped[datePart]) {
                    grouped[datePart] = [];
                }
                grouped[datePart].push(a);
            });
            return grouped;
        }

        /* --- MODAL LOGIC --- */

        /**
         * Opens the modal to show assignments for a specific date.
         */
        function openEventModal(dateKey) {
            const assignmentsByDate = groupAssignmentsByDate(currentAssignments);
            let events = assignmentsByDate[dateKey] || [];
            
            // Sort modal events: Incomplete first, then by priority
            events.sort((a, b) => {
                if (a.isCompleted !== b.isCompleted) return a.isCompleted ? 1 : -1;
                return (b.priority === 'High' ? 3 : b.priority === 'Medium' ? 2 : 1) - 
                       (a.priority === 'High' ? 3 : a.priority === 'Medium' ? 2 : 1);
            });

            // Parse date for display
            const [year, month, day] = dateKey.split('-').map(Number);
            // JavaScript months are 0-indexed, so we use month-1
            const date = new Date(year, month - 1, day); 

            modalDate.textContent = date.toLocaleDateString(undefined, {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            modalEventsList.innerHTML = '';

            if (events.length > 0) {
                noEventsMessage.classList.add('hidden');
                events.forEach(event => modalEventsList.appendChild(createEventCard(event)));
            } else {
                noEventsMessage.classList.remove('hidden');
            }

            // Store the date key currently displayed in the modal
            eventModal.dataset.dateKey = dateKey; 

            eventModal.classList.remove('hidden');
            eventModal.classList.add('flex');
        }

        /**
         * Creates an event card for the modal list.
         */
        function createEventCard(event) {
            const card = document.createElement('div');
            const priorityClass = event.isCompleted ? 'bg-slate-400' : (PRIORITY_COLOR_MAP[event.priority] || 'bg-slate-500');

            card.className = "p-3 bg-slate-100 dark:bg-slate-700 rounded-lg shadow-sm border border-slate-200 dark:border-slate-600";
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <p class="text-base font-semibold ${event.isCompleted ? 'line-through text-slate-500 dark:text-slate-400' : 'text-slate-900 dark:text-white'}">${event.title}</p>
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full text-white ${priorityClass}">${event.priority || 'Low'}</span>
                </div>
                <p class="text-sm text-primary mt-0.5">${event.course}</p>
                <div class="flex items-center space-x-2 mt-2">
                    <input type="checkbox" id="modal-checkbox-${event.id}" class="h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary bg-input-light dark:bg-input-dark" ${event.isCompleted ? 'checked' : ''} onclick="window.toggleAssignmentCompletion('${event.id}', event.target.checked); event.stopPropagation();">
                    <label for="modal-checkbox-${event.id}" class="text-xs text-slate-600 dark:text-slate-300">Mark as ${event.isCompleted ? 'Incomplete' : 'Complete'}</label>
                </div>
            `;
            return card;
        }

        /**
         * Handles the click on the checkbox in the modal for both local and firestore.
         */
        window.toggleAssignmentCompletion = function(assignmentId, newStatus) {
            const dateKey = eventModal.dataset.dateKey; // Get the currently displayed date key

            if (isLocalMode) {
                const index = currentAssignments.findIndex(a => a.id === assignmentId);
                if (index > -1) {
                    currentAssignments[index].isCompleted = newStatus;
                    saveAssignmentsToLocal(currentAssignments);
                    showMessage(`Assignment status updated (Local).`, 'success');
                }
                // Re-render and re-open modal to reflect change immediately
                renderCalendar();
                openEventModal(dateKey);

            } else {
                toggleCompletionFirestore(assignmentId, newStatus);
                // Firestore listener handles the re-render of calendar, but we need to force modal update
                // Delaying to wait for snapshot update is best, but for responsiveness, we just re-open the modal
                setTimeout(() => openEventModal(dateKey), 200); 
            }
        }
        
        // Modal close listener
        closeModalButton.onclick = () => {
            eventModal.classList.add('hidden');
            eventModal.classList.remove('flex');
        };

        /* --- NAVIGATION AND INITIALIZATION --- */

        /**
         * Changes the month displayed by the calendar.
         */
        function changeMonth(direction) {
            displayDate.setMonth(displayDate.getMonth() + direction);
            renderCalendar();
        }

        prevMonthButton.onclick = () => changeMonth(-1);
        nextMonthButton.onclick = () => changeMonth(1);

        /**
         * Initializes Firebase or falls back to Local Mode.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                isLocalMode = true;
                console.warn("Firebase configuration missing. Switching to Local Mode.");
                startLocalModeListener();
                showMessage("Database connection missing. Data loaded from your browser's Local Storage.", "info", 5000);
            } else {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    const auth = getAuth(app);
                    
                    // Authenticate
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    isAuthReady = true;
                    console.log("Firebase initialized and ready. Starting Firestore listener.");
                    startFirestoreListener();
                    
                } catch (error) {
                    console.error("Firebase initialization failed, falling back to Local Mode:", error);
                    isLocalMode = true;
                    isAuthReady = true;
                    startLocalModeListener();
                    showMessage("Database connection failed. Data loaded from Local Storage.", "info", 5000);
                }
            }
        }
        
        // Handle Dark Mode preference on load
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.documentElement.classList.add('dark');
        }

        // Initialize the app on load
        initializeFirebase();

    </script>
</body>
</html>
