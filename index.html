<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Academic Calendar</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        // Tailwind Configuration
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "card-light": "#ffffff",
                        "card-dark": "#1b2734",
                        "accent-red": "#ef4444",
                        "accent-orange": "#f97316",
                        "accent-slate": "#64748b",
                    },
                    fontFamily: {
                        "display": ["Lexend"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
        }
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
        /* Custom calendar cell styling */
        .calendar-cell {
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .calendar-cell:hover:not(.disabled) {
            background-color: rgba(19, 127, 236, 0.1);
        }
        .calendar-cell.selected {
            background-color: #137fec !important;
            color: white !important;
            border-radius: 0.5rem;
        }
        .calendar-cell.selected .day-number, .calendar-cell.selected .dot {
            color: white !important;
        }
        .day-number {
            font-size: 0.875rem; /* sm */
            font-weight: 500; /* medium */
        }
        .calendar-cell.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-card-light dark:bg-card-dark sticky top-0 z-10 shadow-md border-b border-slate-200 dark:border-slate-700">
            <div class="p-4 flex items-center justify-center">
                <h1 class="text-xl font-bold text-slate-900 dark:text-white">Academic Calendar</h1>
            </div>
        </header>

        <!-- Message Box for Feedback -->
        <div id="message-box" class="hidden mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300"></div>

        <!-- Main Content Area -->
        <main class="flex-1 px-4 py-4 overflow-y-auto">
            <!-- Calendar Navigation -->
            <div class="flex items-center justify-between mb-4">
                <button id="prev-month" class="p-2 text-primary hover:text-blue-600 dark:hover:text-blue-400 rounded-full transition-colors">
                    <span class="material-symbols-outlined">chevron_left</span>
                </button>
                <h2 id="current-month-year" class="text-xl font-bold text-slate-900 dark:text-white"></h2>
                <button id="next-month" class="p-2 text-primary hover:text-blue-600 dark:hover:text-blue-400 rounded-full transition-colors">
                    <span class="material-symbols-outlined">chevron_right</span>
                </button>
            </div>

            <!-- Calendar Grid -->
            <div class="bg-card-light dark:bg-card-dark p-3 rounded-xl shadow-lg border border-slate-100 dark:border-slate-700">
                <!-- Weekday Headers -->
                <div class="grid grid-cols-7 text-center text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2">
                    <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                </div>
                <!-- Calendar Days -->
                <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                    <!-- Days will be injected here -->
                </div>
            </div>

            <!-- Daily Assignment List -->
            <div class="mt-6">
                <h3 id="daily-list-header" class="text-xl font-bold mb-3">Assignments for Selected Date</h3>
                <div id="daily-assignment-list" class="space-y-3">
                    <p class="text-slate-500 dark:text-slate-400">Select a date to view assignments.</p>
                </div>
            </div>

        </main>

        <!-- Footer Navigation (Consistent with other pages) -->
        <footer class="bg-card-light dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 sticky bottom-0 z-10">
            <nav class="flex justify-around p-2">
                <!-- Dashboard Link -->
                <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="dashboard.html">
                    <span class="material-symbols-outlined">home</span>
                    <span class="text-xs font-medium">Dashboard</span>
                </a>
                <!-- Assignments Link -->
                <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="assignments.html">
                    <span class="material-symbols-outlined">list_alt</span>
                    <span class="text-xs font-medium">Assignments</span>
                </a>
                <!-- Calendar Link (Active) -->
                <a class="flex flex-col items-center justify-center gap-1 text-primary w-1/4" href="index.html">
                    <span class="material-symbols-outlined">calendar_month</span>
                    <span class="text-xs font-medium">Calendar</span>
                </a>
                <!-- Settings Link -->
                <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="settings.html">
                    <span class="material-symbols-outlined">settings</span>
                    <span class="text-xs font-medium">Settings</span>
                </a>
            </nav>
        </footer>
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('Debug');

        // Global Firebase variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let isAuthReady = false;
        
        let currentDate = new Date();
        let selectedDate = new Date(); // Tracks the date the user has clicked
        let assignmentMap = {}; // Maps date string (YYYY-MM-DD) to a list of assignments and highest priority

        // UI elements
        const messageBox = document.getElementById('message-box');
        const currentMonthYearHeader = document.getElementById('current-month-year');
        const calendarGrid = document.getElementById('calendar-grid');
        const prevMonthButton = document.getElementById('prev-month');
        const nextMonthButton = document.getElementById('next-month');
        const dailyListHeader = document.getElementById('daily-list-header');
        const dailyAssignmentList = document.getElementById('daily-assignment-list');

        const DAYS_OF_WEEK = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const PRIORITY_COLOR_MAP = {
            'High': 'bg-accent-red',
            'Medium': 'bg-accent-orange',
            'Low': 'bg-accent-slate',
            'bg-accent-red': 'High', // Reverse mapping for lookup
            'bg-accent-orange': 'Medium',
            'bg-accent-slate': 'Low',
        };

        /**
         * Utility function to display messages.
         */
        function showMessage(message, type, duration = 3000) {
            let bgColor, textColor;
            switch (type) {
                case 'error':
                    bgColor = 'bg-red-100 dark:bg-red-900';
                    textColor = 'text-red-700 dark:text-red-300';
                    break;
                default:
                    bgColor = 'bg-blue-100 dark:bg-blue-900';
                    textColor = 'text-blue-700 dark:text-blue-300';
            }

            messageBox.className = `block mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 ${bgColor} ${textColor}`;
            messageBox.innerHTML = message;
            messageBox.classList.remove('hidden');

            if (duration > 0) {
                setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                    setTimeout(() => messageBox.classList.add('hidden', 'opacity-100'), 300);
                }, duration);
            }
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                showMessage("Database connection failed. Configuration missing. Calendar data cannot be loaded.", "error", 0);
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                isAuthReady = true;
                console.log("Firebase initialized. Starting calendar listener.");

                startRealtimeAssignmentListener();
                
            } catch (error) {
                console.error("Firebase initialization or authentication error:", error);
                showMessage("Authentication failed. Cannot load calendar data.", "error", 0);
            }
        }

        /**
         * Returns the Firestore collection path for public assignments.
         */
        function getAssignmentsCollection() {
            if (!db || !isAuthReady) {
                return null;
            }
            // Public collection path for shared data
            return collection(db, `artifacts/${appId}/public/data/assignments`);
        }
        
        /**
         * Sets up the real-time listener for all assignments and populates the map.
         */
        function startRealtimeAssignmentListener() {
            const assignmentsCol = getAssignmentsCollection();
            if (!assignmentsCol) return;

            const q = query(assignmentsCol);

            onSnapshot(q, (snapshot) => {
                const assignments = [];
                snapshot.forEach(doc => {
                    assignments.push({ id: doc.id, ...doc.data() });
                });
                
                // Rebuild the assignment map
                processAssignmentsToMap(assignments);
                
                // Re-render the calendar and the daily list
                renderCalendar();
                renderDailyAssignments(selectedDate);

            }, (error) => {
                console.error("Error fetching assignments for calendar:", error);
                showMessage("Failed to load calendar events.", "error");
            });
        }

        /**
         * Processes raw assignments into a date map for quick calendar lookup.
         */
        function processAssignmentsToMap(assignments) {
            assignmentMap = {};

            assignments.filter(a => !a.isCompleted && a.dueDate).forEach(a => {
                // Normalize date to YYYY-MM-DD (due dates are stored as YYYY-MM-DD string)
                const dateKey = a.dueDate; 

                if (!assignmentMap[dateKey]) {
                    assignmentMap[dateKey] = {
                        assignments: [],
                        highestPriority: 'Low', // Start at lowest
                        priorityColor: PRIORITY_COLOR_MAP['Low']
                    };
                }

                assignmentMap[dateKey].assignments.push(a);

                // Update highest priority
                const currentPriority = assignmentMap[dateKey].highestPriority;
                const newPriority = a.priority || 'Low';
                
                if (newPriority === 'High' || (newPriority === 'Medium' && currentPriority === 'Low')) {
                    assignmentMap[dateKey].highestPriority = newPriority;
                    assignmentMap[dateKey].priorityColor = PRIORITY_COLOR_MAP[newPriority];
                }
            });
        }

        /**
         * Core function to render the calendar grid.
         */
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            currentMonthYearHeader.textContent = currentDate.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
            calendarGrid.innerHTML = '';

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const startingDayOfWeek = firstDayOfMonth.getDay(); // 0=Sunday, 6=Saturday
            const daysInMonth = lastDayOfMonth.getDate();

            // 1. Add padding for days before the 1st
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarGrid.insertAdjacentHTML('beforeend', '<div class="p-2"></div>');
            }

            // 2. Add actual days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const isToday = date.toDateString() === new Date().toDateString();
                const isSelected = date.toDateString() === selectedDate.toDateString();
                const hasAssignments = assignmentMap[dateKey] && assignmentMap[dateKey].assignments.length > 0;
                
                const assignmentData = assignmentMap[dateKey];
                
                let cellClasses = 'calendar-cell rounded-lg relative text-slate-800 dark:text-slate-200';
                if (isToday) cellClasses += ' bg-blue-100 dark:bg-slate-700/50 border border-blue-400 dark:border-blue-600';
                if (isSelected) cellClasses += ' selected';
                
                let dotHTML = '';
                if (hasAssignments) {
                    const colorClass = assignmentData.priorityColor;
                    dotHTML = `<div class="dot w-1.5 h-1.5 rounded-full mt-1 ${colorClass}"></div>`;
                }

                const dayHTML = `
                    <div class="${cellClasses}" data-date-key="${dateKey}" data-date="${date.toISOString()}">
                        <span class="day-number">${day}</span>
                        ${dotHTML}
                    </div>
                `;
                calendarGrid.insertAdjacentHTML('beforeend', dayHTML);
            }

            // Re-attach click handlers to the new cells
            document.querySelectorAll('.calendar-cell').forEach(cell => {
                if (cell.dataset.dateKey) {
                    cell.addEventListener('click', () => handleDateSelect(new Date(cell.dataset.date)));
                }
            });
        }
        
        /**
         * Handles selecting a new date on the calendar.
         */
        function handleDateSelect(date) {
            selectedDate = date;
            
            // Remove 'selected' class from all cells
            document.querySelectorAll('.calendar-cell').forEach(cell => cell.classList.remove('selected'));
            
            // Add 'selected' class to the clicked cell
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const cell = document.querySelector(`[data-date-key="${dateKey}"]`);
            if (cell) {
                cell.classList.add('selected');
            }

            renderDailyAssignments(date);
        }

        /**
         * Renders the list of assignments for the selected date.
         */
        function renderDailyAssignments(date) {
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            
            dailyListHeader.textContent = `Assignments for ${date.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}`;
            dailyAssignmentList.innerHTML = '';
            
            const data = assignmentMap[dateKey];

            if (!data || data.assignments.length === 0) {
                dailyAssignmentList.innerHTML = '<p class="text-slate-500 dark:text-slate-400 p-2 rounded-lg">No assignments due on this date.</p>';
                return;
            }

            // Sort by priority (High, Medium, Low)
            const sortedAssignments = data.assignments.sort((a, b) => {
                const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            });


            sortedAssignments.forEach(a => {
                let priorityClass;
                switch(a.priority) {
                    case 'High':
                        priorityClass = 'bg-accent-red';
                        break;
                    case 'Medium':
                        priorityClass = 'bg-accent-orange';
                        break;
                    case 'Low':
                    default:
                        priorityClass = 'bg-accent-slate';
                        break;
                }

                const assignmentCard = document.createElement('a');
                assignmentCard.href = `assignments.html?id=${a.id}`;
                assignmentCard.className = `block p-3 rounded-lg bg-card-light dark:bg-card-dark shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition-shadow`;
                assignmentCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <p class="font-semibold truncate">${a.title}</p>
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full text-white ${priorityClass}">${a.priority || 'Low'}</span>
                    </div>
                    <p class="text-sm text-primary mt-1">${a.course}</p>
                `;
                dailyAssignmentList.appendChild(assignmentCard);
            });
        }
        
        /**
         * Moves the calendar to the previous month.
         */
        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        /**
         * Moves the calendar to the next month.
         */
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        // --- Event Listeners ---
        prevMonthButton.addEventListener('click', prevMonth);
        nextMonthButton.addEventListener('click', nextMonth);
        
        // Initialize Firebase and set up listeners
        initializeFirebase();

        // Initial render: Set selected date to today and render calendar
        selectedDate = new Date();
        renderCalendar();
        renderDailyAssignments(selectedDate);
    </script>
</body>
</html>
