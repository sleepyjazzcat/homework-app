<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Academic Calendar</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        // Tailwind Configuration
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "card-light": "#ffffff",
                        "card-dark": "#1b2734",
                        "accent-red": "#ef4444",
                        "accent-green": "#10b981",
                        "accent-blue": "#3b82f6",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
        }
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
        .day-cell {
            position: relative;
            aspect-ratio: 1 / 1; /* Ensures square cells */
            min-height: 50px;
        }
        /* Dot indicators based on priority */
        .dot-indicator {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none; /* Allows click to pass through to the day cell */
        }
        .priority-high {
            background-color: theme('colors.accent-red');
        }
        .priority-medium {
            background-color: theme('colors.primary');
        }
        .priority-low {
            background-color: theme('colors.accent-green');
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200 flex flex-col min-h-screen">

    <!-- Assignment Detail Modal (Hidden by default) -->
    <div id="assignment-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-card-light dark:bg-card-dark rounded-xl p-6 shadow-2xl w-full max-w-lg max-h-[90dvh] overflow-y-auto">
            <div class="flex items-start justify-between mb-4">
                <h3 id="modal-date-title" class="text-xl font-bold text-primary">Assignments on...</h3>
                <button id="modal-close" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="modal-assignment-list" class="space-y-4">
                <!-- Assignments for the selected day will be injected here -->
            </div>
            <p id="modal-no-assignments" class="text-center text-slate-500 dark:text-slate-400 py-6 hidden">No assignments due on this day.</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-card-light dark:bg-card-dark sticky top-0 z-10 shadow-md border-b border-slate-200 dark:border-slate-700">
        <div class="p-4 flex items-center justify-between">
            <h1 id="month-year-display" class="text-xl font-bold text-slate-900 dark:text-white">Loading Calendar...</h1>
            <div class="flex space-x-2">
                <button id="prev-month" class="p-2 text-primary hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors">
                    <span class="material-symbols-outlined">chevron_left</span>
                </button>
                <button id="next-month" class="p-2 text-primary hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors">
                    <span class="material-symbols-outlined">chevron_right</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-4 overflow-y-auto space-y-4">
        
        <!-- Day Names -->
        <div class="grid grid-cols-7 gap-1 text-center text-xs font-medium text-slate-500 dark:text-slate-400">
            <span>SUN</span>
            <span>MON</span>
            <span>TUE</span>
            <span>WED</span>
            <span>THU</span>
            <span>FRI</span>
            <span>SAT</span>
        </div>

        <!-- Calendar Grid -->
        <div id="calendar-grid" class="grid grid-cols-7 gap-1 bg-card-light dark:bg-card-dark p-2 rounded-xl shadow-lg">
            <!-- Days will be rendered here -->
            <p class="col-span-7 text-center py-12 text-slate-500 dark:text-slate-400">Initializing...</p>
        </div>

        <!-- Connection Status -->
        <div id="connection-status" class="text-center p-3 rounded-xl text-sm font-medium text-slate-500 dark:text-slate-400 mt-4">
            Checking Connection...
        </div>

    </main>

    <!-- Footer Navigation (Consistent with other pages) -->
    <footer class="bg-card-light dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 sticky bottom-0 z-10">
        <nav class="flex justify-around p-2">
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="dashboard.html">
                <span class="material-symbols-outlined">home</span>
                <span class="text-xs font-medium">Dashboard</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="assignments.html">
                <span class="material-symbols-outlined">list_alt</span>
                <span class="text-xs font-medium">Assignments</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-primary w-1/4" href="index.html">
                <span class="material-symbols-outlined">calendar_month</span>
                <span class="text-xs font-medium">Calendar</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="settings.html">
                <span class="material-symbols-outlined">settings</span>
                <span class="text-xs font-medium">Settings</span>
            </a>
        </nav>
    </footer>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Application State
        let db = null;
        let currentMonth = new Date();
        let allAssignments = [];
        let isLocalMode = false;
        let isAuthReady = false;
        const LOCAL_STORAGE_KEY = `academicPlanner_assignments_${appId}`;
        const priorityOrder = { 'High': 1, 'Medium': 2, 'Low': 3 };

        // UI Elements
        const monthYearDisplay = document.getElementById('month-year-display');
        const calendarGrid = document.getElementById('calendar-grid');
        const prevMonthButton = document.getElementById('prev-month');
        const nextMonthButton = document.getElementById('next-month');
        const connectionStatusEl = document.getElementById('connection-status');
        const modal = document.getElementById('assignment-modal');
        const modalDateTitle = document.getElementById('modal-date-title');
        const modalAssignmentList = document.getElementById('modal-assignment-list');
        const modalNoAssignments = document.getElementById('modal-no-assignments');
        const modalCloseButton = document.getElementById('modal-close');

        /* --- DARK MODE LOGIC (for consistency) --- */
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.documentElement.classList.add('dark');
        }

        /* --- UTILITY FUNCTIONS --- */

        /**
         * Reads all assignments from local storage.
         */
        function getAssignmentsFromLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Error reading from local storage:", error);
                return [];
            }
        }

        /**
         * Formats a date string to YYYY-MM-DD for comparison.
         */
        function formatToDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        /**
         * Closes the assignment detail modal.
         */
        modalCloseButton.onclick = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        /* --- CALENDAR RENDERING --- */

        /**
         * Calculates assignment indicators for the entire month.
         */
        function getIndicatorsByDate(assignments) {
            const indicators = {};
            assignments.forEach(a => {
                // Ignore completed assignments
                if (a.isCompleted) return; 

                const dateKey = a.dueDate; // Assumes YYYY-MM-DD format
                
                if (!indicators[dateKey]) {
                    indicators[dateKey] = a.priority;
                } else {
                    // Update indicator if the new assignment has a higher priority
                    if (priorityOrder[a.priority] < priorityOrder[indicators[dateKey]]) {
                        indicators[dateKey] = a.priority;
                    }
                }
            });
            return indicators;
        }

        /**
         * Renders the calendar grid based on the current month and assignment data.
         */
        function renderCalendar() {
            const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const firstDayOfMonth = date.getDay(); // 0=Sunday, 6=Saturday
            const monthLength = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const today = new Date();
            const todayKey = formatToDateKey(today);

            monthYearDisplay.textContent = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            calendarGrid.innerHTML = '';
            
            const indicators = getIndicatorsByDate(allAssignments);

            // Fill in preceding empty days
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.innerHTML += '<div class="day-cell bg-slate-100 dark:bg-slate-800 rounded-lg text-slate-400"></div>';
            }

            // Fill in days of the month
            for (let day = 1; day <= monthLength; day++) {
                const dayDate = new Date(date.getFullYear(), date.getMonth(), day);
                const dayKey = formatToDateKey(dayDate);
                const isToday = dayKey === todayKey;
                const indicatorPriority = indicators[dayKey];

                let cellClass = 'day-cell p-2 rounded-lg text-center font-medium transition-colors cursor-pointer';
                let dayNumClass = 'text-sm';
                let indicatorHTML = '';

                if (isToday) {
                    cellClass += ' border-2 border-primary ring-2 ring-primary bg-card-light dark:bg-card-dark';
                    dayNumClass += ' text-primary font-bold';
                } else {
                    cellClass += ' bg-card-light dark:bg-card-dark hover:bg-slate-50 dark:hover:bg-slate-700';
                }

                if (indicatorPriority) {
                    const priorityClass = `priority-${indicatorPriority.toLowerCase()}`;
                    indicatorHTML = `<div class="dot-indicator ${priorityClass}"></div>`;
                }

                const dayCell = document.createElement('div');
                dayCell.className = cellClass;
                dayCell.innerHTML = `<span class="${dayNumClass}">${day}</span>${indicatorHTML}`;
                dayCell.dataset.dateKey = dayKey;
                dayCell.onclick = () => showAssignmentModal(dayDate, dayKey);

                calendarGrid.appendChild(dayCell);
            }
        }

        /**
         * Renders the assignment modal for a specific day.
         */
        function showAssignmentModal(date, dateKey) {
            const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            modalDateTitle.textContent = formattedDate;
            modalAssignmentList.innerHTML = '';

            const assignmentsForDay = allAssignments.filter(a => a.dueDate === dateKey).sort((a, b) => {
                // Sort by priority and then completion status
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return (a.isCompleted === b.isCompleted) ? 0 : a.isCompleted ? 1 : -1;
            });

            if (assignmentsForDay.length > 0) {
                modalNoAssignments.classList.add('hidden');
                assignmentsForDay.forEach(a => {
                    const statusIcon = a.isCompleted ? 'check_circle' : 'pending_actions';
                    const statusColor = a.isCompleted ? 'text-accent-green' : 'text-accent-red';
                    const priorityColor = a.priority === 'High' ? 'text-accent-red' : a.priority === 'Medium' ? 'text-primary' : 'text-accent-green';
                    
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-slate-100 dark:bg-slate-800 rounded-lg shadow-sm border-l-4 border-slate-300 dark:border-slate-700 space-y-1';
                    item.innerHTML = `
                        <div class="flex items-center justify-between">
                            <p class="font-semibold text-slate-800 dark:text-slate-200">${a.title}</p>
                            <span class="material-symbols-outlined text-xl ${statusColor}">${statusIcon}</span>
                        </div>
                        <p class="text-xs text-slate-600 dark:text-slate-400">${a.course} &bullet; Priority: <span class="${priorityColor}">${a.priority}</span></p>
                        ${a.notes ? `<p class="text-xs italic text-slate-500 dark:text-slate-500 mt-1">${a.notes}</p>` : ''}
                        <a href="assignments.html#${a.id}" class="block text-right text-xs text-primary hover:underline mt-2">View Details & Edit</a>
                    `;
                    modalAssignmentList.appendChild(item);
                });
            } else {
                modalNoAssignments.classList.remove('hidden');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        /* --- NAVIGATION --- */

        prevMonthButton.onclick = () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        };

        nextMonthButton.onclick = () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        };


        /* --- DATA FETCHING --- */

        /**
         * Handles incoming data (either from Firestore or Local Storage).
         */
        function handleDataUpdate(assignments) {
            allAssignments = assignments;
            renderCalendar();
        }

        /**
         * Main function to fetch data and listen for updates (Local or Database).
         */
        function setupDataListener() {
            if (!isAuthReady) return;

            if (isLocalMode) {
                // --- LOCAL MODE ---
                connectionStatusEl.textContent = 'Local Mode (Data from browser)';
                connectionStatusEl.classList.add('text-orange-600', 'dark:text-orange-400');
                
                const assignments = getAssignmentsFromLocal();
                handleDataUpdate(assignments);
                
                // Note: In Local Mode, the data is static until the page is reloaded.
                // We render once and rely on user refresh for new data.

            } else {
                // --- DATABASE MODE (Firebase) ---
                connectionStatusEl.textContent = 'Database Connected (Real-time)';
                connectionStatusEl.classList.add('text-green-600', 'dark:text-green-400');

                const assignmentsColRef = collection(db, `artifacts/${appId}/public/data/assignments`);
                const q = query(assignmentsColRef);
                
                // Real-time listener
                onSnapshot(q, (snapshot) => {
                    const assignments = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(),
                        isCompleted: doc.data().isCompleted || false,
                        priority: doc.data().priority || 'Medium',
                        dueDate: doc.data().dueDate || new Date().toISOString().split('T')[0]
                    }));
                    
                    handleDataUpdate(assignments);
                }, (error) => {
                    console.error("Firestore error:", error);
                    connectionStatusEl.textContent = 'DB Failed (Check console)';
                    connectionStatusEl.classList.add('text-red-600', 'dark:text-red-400');
                    // Fallback to local on connection error
                    isLocalMode = true; 
                    setupDataListener(); // Try again in local mode
                });
            }
        }


        /* --- INITIALIZATION --- */

        /**
         * Initializes Firebase or falls back to Local Mode.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                isLocalMode = true;
                isAuthReady = true;
                connectionStatusEl.textContent = 'Local Mode (No DB)';
                connectionStatusEl.classList.add('text-orange-600', 'dark:text-orange-400');
                setupDataListener();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                isAuthReady = true;
                setupDataListener();

            } catch (error) {
                console.error("Firebase initialization failed, falling back to Local Mode:", error);
                isLocalMode = true;
                isAuthReady = true;
                connectionStatusEl.textContent = 'DB Failed/Local Mode';
                connectionStatusEl.classList.add('text-orange-600', 'dark:text-orange-400');
                setupDataListener();
            }
        }
        
        // Initialize the app
        initializeFirebase();

    </script>
</body>
</html>
