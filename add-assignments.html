<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>New Assignment</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        // Tailwind Configuration
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "foreground-light": "#101922",
                        "foreground-dark": "#f6f7f8",
                        "card-light": "#ffffff",
                        "card-dark": "#1b2734",
                        "input-light": "#eef1f4",
                        "input-dark": "#2a3b4c",
                        "placeholder-light": "#6b7f99",
                        "placeholder-dark": "#8a9eb5",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
        body {
            min-height: 100dvh;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-foreground-light dark:text-foreground-dark flex flex-col min-h-screen">

    <header class="flex items-center p-4 border-b border-input-light dark:border-input-dark bg-card-light dark:bg-card-dark sticky top-0 z-10">
        <a href="dashboard.html" class="p-2 text-foreground-light dark:text-foreground-dark">
            <span class="material-symbols-outlined">close</span>
        </a>
        <h1 class="flex-1 text-lg font-bold text-center -ml-10">New Assignment</h1>
    </header>

    <!-- Message Box for Feedback -->
    <div id="message-box" class="mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 hidden"></div>

    <main class="flex-1 p-4 overflow-y-auto">
        <form id="assignment-form" class="space-y-6">
            <div>
                <label class="sr-only" for="assignment-name">Assignment Name</label>
                <input class="w-full bg-input-light dark:bg-input-dark border-none rounded-lg h-14 px-4 placeholder-placeholder-light dark:placeholder-placeholder-dark focus:ring-2 focus:ring-primary" id="assignment-name" placeholder="Assignment Name" type="text" required/>
            </div>
            
            <div>
                <label class="sr-only" for="course">Class</label>
                <div class="relative">
                    <select class="w-full appearance-none bg-input-light dark:bg-input-dark border-none rounded-lg h-14 px-4 text-foreground-light dark:text-foreground-dark focus:ring-2 focus:ring-primary [&:not([value])]:text-placeholder-light dark:[&:not([value])]:text-placeholder-dark" id="course" required>
                        <option value="" disabled selected>Class (Required)</option>
                        <option value="Mathematics">Mathematics</option>
                        <option value="Science">Science</option>
                        <option value="History">History</option>
                        <option value="English">English</option>
                        <option value="Art">Art</option>
                        <option value="Other">Other</option>
                    </select>
                    <span class="material-symbols-outlined absolute top-1/2 right-4 -translate-y-1/2 pointer-events-none text-placeholder-light dark:text-placeholder-dark">expand_more</span>
                </div>
            </div>
            
            <div>
                <label class="sr-only" for="due-date">Due Date</label>
                <div class="relative">
                    <!-- Note: Type is text initially, switches to date on focus -->
                    <input class="w-full bg-input-light dark:bg-input-dark border-none rounded-lg h-14 px-4 placeholder-placeholder-light dark:placeholder-placeholder-dark focus:ring-2 focus:ring-primary" id="due-date" onblur="(this.type='text')" onfocus="(this.type='date')" placeholder="Due Date (Required)" type="text" required/>
                    <span class="material-symbols-outlined absolute top-1/2 right-4 -translate-y-1/2 pointer-events-none text-placeholder-light dark:text-placeholder-dark">calendar_today</span>
                </div>
            </div>

            <div>
                <label class="sr-only" for="priority">Priority</label>
                <div class="relative">
                    <select class="w-full appearance-none bg-input-light dark:bg-input-dark border-none rounded-lg h-14 px-4 text-foreground-light dark:text-foreground-dark focus:ring-2 focus:ring-primary" id="priority">
                        <option value="Low" selected>Priority: Low</option>
                        <option value="Medium">Priority: Medium</option>
                        <option value="High">Priority: High</option>
                    </select>
                    <span class="material-symbols-outlined absolute top-1/2 right-4 -translate-y-1/2 pointer-events-none text-placeholder-light dark:text-placeholder-dark">expand_more</span>
                </div>
            </div>
            
            <div>
                <label class="sr-only" for="description">Description</label>
                <textarea class="w-full bg-input-light dark:bg-input-dark border-none rounded-lg p-4 placeholder-placeholder-light dark:placeholder-placeholder-dark focus:ring-2 focus:ring-primary" id="description" placeholder="Description (Optional)" rows="4"></textarea>
            </div>
            
        </form>
    </main>
    
    <footer class="p-4 border-t border-input-light dark:border-input-dark bg-card-light dark:bg-card-dark">
        <button id="create-button" class="w-full bg-primary text-white font-bold h-12 rounded-lg text-base tracking-wide transition-colors disabled:bg-slate-400 dark:disabled:bg-slate-600 disabled:cursor-not-allowed" disabled>
            Initializing...
        </button>
    </footer>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let isAuthReady = false;
        let isLocalMode = false;
        const LOCAL_STORAGE_KEY = `academicPlanner_assignments_${appId}`;

        // UI elements
        const form = document.getElementById('assignment-form');
        const createButton = document.getElementById('create-button');
        const messageBox = document.getElementById('message-box');

        /**
         * Utility function to display messages.
         */
        function showMessage(message, type, duration = 3000) {
            let bgColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 dark:bg-green-900';
                    textColor = 'text-green-700 dark:text-green-300';
                    break;
                case 'error':
                    bgColor = 'bg-red-100 dark:bg-red-900';
                    textColor = 'text-red-700 dark:text-red-300';
                    break;
                case 'info':
                    bgColor = 'bg-blue-100 dark:bg-blue-900';
                    textColor = 'text-blue-700 dark:text-blue-300';
                    break;
                default:
                    bgColor = 'bg-gray-100 dark:bg-gray-700';
                    textColor = 'text-gray-800 dark:text-gray-200';
            }

            messageBox.className = `block mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 ${bgColor} ${textColor}`;
            messageBox.innerHTML = message;
            messageBox.classList.remove('hidden');

            if (duration > 0) {
                setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                    setTimeout(() => messageBox.classList.add('hidden', 'opacity-100'), 300);
                }, duration);
            }
        }
        
        /**
         * Checks required fields and toggles the button state.
         */
        function validateForm() {
            if (!isAuthReady && !isLocalMode) {
                createButton.disabled = true;
                return;
            }

            const isTitleValid = document.getElementById('assignment-name').value.trim() !== '';
            const isClassValid = document.getElementById('course').value.trim() !== '';
            const isDateValid = document.getElementById('due-date').value.trim() !== '';

            createButton.disabled = !(isTitleValid && isClassValid && isDateValid);
        }

        /**
         * Handles saving data to Local Storage.
         */
        function saveToLocalStorage(assignmentData) {
            try {
                // Get existing assignments or initialize an empty array
                const existingAssignments = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
                
                // Add new assignment with a temporary ID
                const newAssignment = {
                    ...assignmentData,
                    id: Date.now().toString(), // Simple unique ID for local storage
                    createdAt: new Date().toISOString()
                };
                
                existingAssignments.push(newAssignment);
                
                // Save back to local storage
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(existingAssignments));
                
                return { success: true };

            } catch (error) {
                console.error("Local Storage save error:", error);
                return { success: false, error: "Failed to save data locally." };
            }
        }
        
        /**
         * Handles the form submission event.
         */
        async function handleCreateAssignment(event) {
            event.preventDefault();
            createButton.disabled = true;
            createButton.textContent = 'Saving...';

            if (!isAuthReady && !isLocalMode) {
                 showMessage("Error: Connection is not ready.", "error");
                 createButton.textContent = 'Create Assignment';
                 validateForm();
                 return;
            }
            
            const assignmentData = {
                title: document.getElementById('assignment-name').value.trim(),
                course: document.getElementById('course').value,
                dueDate: document.getElementById('due-date').value,
                priority: document.getElementById('priority').value,
                description: document.getElementById('description').value.trim(),
                isCompleted: false,
            };

            let result;

            if (isLocalMode) {
                // LOCAL STORAGE MODE
                result = saveToLocalStorage(assignmentData);
            } else {
                // FIREBASE MODE
                try {
                    const assignmentsCol = collection(db, `artifacts/${appId}/public/data/assignments`);
                    await addDoc(assignmentsCol, assignmentData);
                    result = { success: true };
                } catch (error) {
                    console.error("Firestore save error:", error);
                    result = { success: false, error: "Failed to save to database." };
                }
            }

            if (result.success) {
                showMessage("Assignment created successfully!", "success");
                setTimeout(() => {
                    // Redirect back to the main assignments list
                    window.location.href = 'assignments.html';
                }, 1000);
            } else {
                showMessage(`Error creating assignment: ${result.error}`, "error", 5000);
                createButton.textContent = 'Create Assignment';
            }
            validateForm();
        }

        /**
         * Initializes Firebase or falls back to Local Mode.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                isLocalMode = true;
                console.warn("Firebase configuration missing. Switching to Local Mode.");
                createButton.textContent = 'Create Assignment (Local Mode)';
                isAuthReady = true; // Signal readiness for Local Mode
                showMessage("Database connection missing. Data will be saved only in your browser (Local Mode).", "info", 0);
            } else {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    const auth = getAuth(app);
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    isAuthReady = true;
                    console.log("Firebase initialized and ready.");
                    createButton.textContent = 'Create Assignment';
                    showMessage("Connected to database. Data is shared and persistent.", "success");
                    
                } catch (error) {
                    // If Firebase initialization fails despite having config (e.g., rules error), fall back to local
                    console.error("Firebase initialization failed, falling back to Local Mode:", error);
                    isLocalMode = true;
                    isAuthReady = true;
                    createButton.textContent = 'Create Assignment (Local Mode)';
                    showMessage("Database connection failed. Data will be saved only in your browser (Local Mode).", "info", 0);
                }
            }
            
            // Add listeners after mode is determined
            form.addEventListener('input', validateForm);
            form.addEventListener('submit', handleCreateAssignment);
            validateForm(); // Initial validation check
        }
        
        // Initialize the app on load
        initializeFirebase();

        // Handle Dark Mode preference on load
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.documentElement.classList.add('dark');
        }
    </script>
</body>
</html>
