<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Add New Assignment</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        // Tailwind Configuration
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "card-light": "#ffffff",
                        "card-dark": "#1b2734",
                        "accent-red": "#ef4444",
                        "accent-green": "#10b981",
                        "accent-blue": "#3b82f6",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
        }
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-card-light dark:bg-card-dark sticky top-0 z-10 shadow-md border-b border-slate-200 dark:border-slate-700">
        <div class="p-4 flex items-center justify-between">
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">New Assignment</h1>
            <a href="assignments.html" class="p-2 text-primary hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors">
                <span class="material-symbols-outlined text-2xl">close</span>
            </a>
        </div>
    </header>

    <!-- Message Box for Feedback -->
    <div id="message-box" class="mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 hidden"></div>

    <!-- Main Content: Form -->
    <main class="flex-1 p-4 overflow-y-auto">
        <form id="assignment-form" class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-lg space-y-6">
            
            <!-- Connection Status -->
            <div id="connection-status" class="text-center p-3 rounded-lg text-sm font-medium">
                Initializing...
            </div>

            <!-- Title -->
            <div class="space-y-2">
                <label for="title" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Assignment Title</label>
                <input type="text" id="title" required class="w-full rounded-lg border-slate-300 shadow-sm focus:border-primary focus:ring-primary bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="e.g., Final Essay on Moby Dick">
            </div>

            <!-- Course -->
            <div class="space-y-2">
                <label for="course" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Course / Subject</label>
                <input type="text" id="course" required class="w-full rounded-lg border-slate-300 shadow-sm focus:border-primary focus:ring-primary bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="e.g., English Literature 101">
            </div>

            <!-- Due Date and Priority -->
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label for="dueDate" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Due Date</label>
                    <input type="date" id="dueDate" required class="w-full rounded-lg border-slate-300 shadow-sm focus:border-primary focus:ring-primary bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                </div>
                <div class="space-y-2">
                    <label for="priority" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Priority</label>
                    <select id="priority" class="w-full rounded-lg border-slate-300 shadow-sm focus:border-primary focus:ring-primary bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
            </div>

            <!-- Notes -->
            <div class="space-y-2">
                <label for="notes" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Notes (Optional)</label>
                <textarea id="notes" rows="3" class="w-full rounded-lg border-slate-300 shadow-sm focus:border-primary focus:ring-primary bg-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Key instructions, resources, or reminders."></textarea>
            </div>

            <!-- Submission Button -->
            <button type="submit" id="submit-button" class="w-full flex items-center justify-center p-3 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors disabled:opacity-50" disabled>
                <span class="material-symbols-outlined mr-2">add_task</span>
                <span id="button-text">Initializing...</span>
            </button>
        </form>
    </main>

    <!-- Footer Navigation (Consistent with other pages) -->
    <footer class="bg-card-light dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 sticky bottom-0 z-10">
        <nav class="flex justify-around p-2">
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="dashboard.html">
                <span class="material-symbols-outlined">home</span>
                <span class="text-xs font-medium">Dashboard</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="assignments.html">
                <span class="material-symbols-outlined">list_alt</span>
                <span class="text-xs font-medium">Assignments</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="index.html">
                <span class="material-symbols-outlined">calendar_month</span>
                <span class="text-xs font-medium">Calendar</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="settings.html">
                <span class="material-symbols-outlined">settings</span>
                <span class="text-xs font-medium">Settings</span>
            </a>
        </nav>
    </footer>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Application State
        let db = null;
        let auth = null;
        // Determine mode immediately: if config is missing, we MUST use local storage.
        const isLocalMode = !firebaseConfig;
        const LOCAL_STORAGE_KEY = `academicPlanner_assignments_${appId}`;

        // UI Elements
        const form = document.getElementById('assignment-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const connectionStatusDiv = document.getElementById('connection-status');
        const requiredInputs = [
            document.getElementById('title'),
            document.getElementById('course'),
            document.getElementById('dueDate')
        ];

        /* --- UI UTILITY FUNCTIONS --- */

        /**
         * Utility function to display messages.
         */
        function showMessage(message, type, duration = 3000) {
            const messageBox = document.getElementById('message-box');
            let bgColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 dark:bg-green-900';
                    textColor = 'text-green-700 dark:text-green-300';
                    break;
                case 'error':
                    bgColor = 'bg-red-100 dark:bg-red-900';
                    textColor = 'text-red-700 dark:text-red-300';
                    break;
                case 'info':
                    bgColor = 'bg-blue-100 dark:bg-blue-900';
                    textColor = 'text-blue-700 dark:text-blue-300';
                    break;
                default:
                    bgColor = 'bg-gray-100 dark:bg-gray-700';
                    textColor = 'text-gray-800 dark:text-gray-200';
            }

            messageBox.className = `block mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 ${bgColor} ${textColor}`;
            messageBox.innerHTML = message;
            messageBox.classList.remove('hidden');

            if (duration > 0) {
                setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                    setTimeout(() => messageBox.classList.add('hidden', 'opacity-100'), 300);
                }, duration);
            }
        }

        /**
         * Clears all input fields after successful submission.
         */
        function clearForm() {
            form.reset();
            document.getElementById('priority').value = 'Medium'; 
            document.getElementById('title').focus(); 
            // Re-check validation state after clearing
            checkFormValidation();
        }
        
        /**
         * Checks if all required fields are filled to enable the button.
         */
        function checkFormValidation() {
            const isFormValid = requiredInputs.every(input => input.value.trim() !== '');
            // Only enable if the form is valid AND initialization is complete
            if (isFormValid && submitButton.dataset.ready === 'true') {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }
        
        // Add listeners to enable/disable button dynamically
        requiredInputs.forEach(input => input.addEventListener('input', checkFormValidation));
        document.getElementById('priority').addEventListener('change', checkFormValidation);
        
        /* --- DATA MANIPULATION FUNCTIONS --- */

        /**
         * Reads all assignments from local storage.
         */
        function getAssignmentsFromLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Error reading from local storage:", error);
                return [];
            }
        }
        
        /**
         * Saves assignment data to local storage (FIXED: ensures array manipulation).
         */
        function saveAssignmentLocal(assignmentData) {
            try {
                // 1. Give the assignment a unique ID
                assignmentData.id = crypto.randomUUID(); 
                
                // 2. Fetch existing data
                const assignments = getAssignmentsFromLocal();

                // 3. Append the new assignment
                assignments.push(assignmentData);

                // 4. Save the entire array back to local storage
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(assignments));

                showMessage("Assignment created successfully (Local Mode). Redirecting...", "success");
                clearForm();
                
                // Redirect user to the assignments list to see the change
                setTimeout(() => {
                    window.location.href = "assignments.html";
                }, 500);

            } catch (error) {
                console.error("Error writing to local storage:", error);
                showMessage("Error: Failed to save assignment locally.", "error");
            } finally {
                // Button enablement is handled by validation check, not here.
            }
        }
        
        /**
         * Saves assignment data to Firebase Firestore.
         */
        async function saveAssignmentFirestore(assignmentData) {
            try {
                if (!db || !auth.currentUser) {
                    throw new Error("Database not connected or user not authenticated.");
                }
                
                const assignmentsCol = collection(db, `artifacts/${appId}/public/data/assignments`);
                await addDoc(assignmentsCol, assignmentData);
                
                showMessage("Assignment created successfully (Database mode). Redirecting...", "success");
                clearForm();
                
                // Redirect user to the assignments list to see the change
                setTimeout(() => {
                    window.location.href = "assignments.html";
                }, 500);

            } catch (error) {
                console.error("Error writing document to Firestore:", error);
                showMessage(`Error saving assignment to database: ${error.message}.`, "error");
            } finally {
                // Re-check validation state after submission attempt
                checkFormValidation();
            }
        }

        /* --- FORM SUBMISSION HANDLER --- */

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Disable button during processing
            submitButton.disabled = true;

            const assignmentData = {
                title: document.getElementById('title').value,
                course: document.getElementById('course').value,
                dueDate: document.getElementById('dueDate').value, 
                priority: document.getElementById('priority').value,
                notes: document.getElementById('notes').value,
                createdAt: new Date().toISOString(),
                isCompleted: false,
            };

            if (isLocalMode) {
                saveAssignmentLocal(assignmentData);
            } else {
                await saveAssignmentFirestore(assignmentData);
            }
        });

        /* --- INITIALIZATION --- */
        
        /**
         * Finalizes initialization steps after determining mode.
         */
        function finalizeInitialization(success) {
            submitButton.dataset.ready = 'true';
            
            if (isLocalMode) {
                connectionStatusDiv.textContent = `Local Mode (Data is saved only in this browser)`;
                connectionStatusDiv.classList.add('bg-orange-100', 'text-orange-800', 'dark:bg-orange-800', 'dark:text-orange-200');
                buttonText.textContent = 'Create Assignment (Local Mode)';
            } else if (success) {
                connectionStatusDiv.textContent = 'Database Connected (Shared Data)';
                connectionStatusDiv.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-800', 'dark:text-green-200');
                buttonText.textContent = 'Create Assignment';
            } else {
                 // Fallback status if DB attempt failed and we are stuck in Local Mode
                connectionStatusDiv.textContent = 'Local Mode (DB connection failed)';
                connectionStatusDiv.classList.add('bg-orange-100', 'text-orange-800', 'dark:bg-orange-800', 'dark:text-orange-200');
                buttonText.textContent = 'Create Assignment (Local Mode)';
            }
            // Re-check validation to potentially enable the button if fields are already filled
            checkFormValidation();
        }


        /**
         * Initializes Firebase or falls back to Local Mode.
         * The function name was changed to avoid shadowing error in module scope.
         */
        async function startApplication() {
            if (isLocalMode) {
                finalizeInitialization(false); // Success status is irrelevant in forced local mode
                return;
            } 
            
            // Attempt to connect to Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                finalizeInitialization(true);

            } catch (error) {
                console.error("Firebase initialization failed, forcing Local Mode:", error);
                // Even though isLocalMode was initially false, the connection failed.
                // We use the Local Mode UI status here.
                finalizeInitialization(false);
            }
        }

        // Initialize the app on load
        startApplication();

    </script>
</body>
</html>
