<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Dashboard Overview</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        // Tailwind Configuration
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "card-light": "#ffffff",
                        "card-dark": "#1b2734",
                        "accent-red": "#ef4444",
                        "accent-green": "#10b981",
                        "accent-blue": "#3b82f6",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
        }
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-card-light dark:bg-card-dark sticky top-0 z-10 shadow-md border-b border-slate-200 dark:border-slate-700">
        <div class="p-4 flex items-center justify-between">
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">Dashboard</h1>
            <a href="add-assignments.html" class="p-2 text-primary hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors">
                <span class="material-symbols-outlined text-2xl">add_circle</span>
            </a>
        </div>
    </header>

    <!-- Message Box for Feedback -->
    <div id="message-box" class="mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 p-4 overflow-y-auto space-y-6">
        
        <!-- User Welcome and Status -->
        <div class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-lg">
            <h2 id="greeting" class="text-2xl font-bold mb-2">Hello, Planner!</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400">
                You are currently logged in with ID: <span id="user-id-display" class="font-mono text-xs px-2 py-0.5 rounded bg-slate-200 dark:bg-slate-700">Loading...</span>
            </p>
            <p id="status-message" class="text-sm mt-3 text-primary font-medium">Connecting to your data...</p>
        </div>

        <!-- Key Metrics Section -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            
            <!-- Card 1: Upcoming Assignments -->
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-lg border-l-4 border-accent-blue">
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Upcoming</p>
                <p id="upcoming-count" class="text-3xl font-bold mt-1 text-accent-blue">0</p>
            </div>

            <!-- Card 2: Completed Today -->
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-lg border-l-4 border-accent-green">
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Completed</p>
                <p id="completed-count" class="text-3xl font-bold mt-1 text-accent-green">0</p>
            </div>

            <!-- Card 3: Overdue -->
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-lg border-l-4 border-accent-red col-span-2 md:col-span-1">
                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Overdue</p>
                <p id="overdue-count" class="text-3xl font-bold mt-1 text-accent-red">0</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="space-y-3 pt-4">
            <h3 class="text-lg font-bold">Quick Actions</h3>
            <a href="assignments.html" class="flex items-center justify-between p-4 bg-primary text-white rounded-xl shadow-md hover:bg-blue-600 transition-colors">
                <span class="font-medium">View All Assignments</span>
                <span class="material-symbols-outlined">arrow_forward</span>
            </a>
            <a href="add-assignments.html" class="flex items-center justify-between p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-md border border-slate-200 dark:border-slate-700 hover:shadow-lg transition-shadow">
                <span class="font-medium">Add New Assignment</span>
                <span class="material-symbols-outlined text-primary">add</span>
            </a>
        </div>
        
    </main>

    <!-- Footer Navigation -->
    <footer class="bg-card-light dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 sticky bottom-0 z-10">
        <nav class="flex justify-around p-2">
            <a class="flex flex-col items-center justify-center gap-1 text-primary w-1/4" href="dashboard.html">
                <span class="material-symbols-outlined">home</span>
                <span class="text-xs font-medium">Dashboard</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="assignments.html">
                <span class="material-symbols-outlined">list_alt</span>
                <span class="text-xs font-medium">Assignments</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="index.html">
                <span class="material-symbols-outlined">calendar_month</span>
                <span class="text-xs font-medium">Calendar</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="settings.html">
                <span class="material-symbols-outlined">settings</span>
                <span class="text-xs font-medium">Settings</span>
            </a>
        </nav>
    </footer>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let isAuthReady = false;
        let isLocalMode = false;
        const LOCAL_STORAGE_KEY = `academicPlanner_assignments_${appId}`;

        // UI elements
        const userIdDisplay = document.getElementById('user-id-display');
        const statusMessage = document.getElementById('status-message');
        const upcomingCount = document.getElementById('upcoming-count');
        const completedCount = document.getElementById('completed-count');
        const overdueCount = document.getElementById('overdue-count');
        
        /**
         * Utility function to display messages. (Reused from assignments.html)
         */
        function showMessage(message, type, duration = 3000) {
            const messageBox = document.getElementById('message-box');
            let bgColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 dark:bg-green-900';
                    textColor = 'text-green-700 dark:text-green-300';
                    break;
                case 'error':
                    bgColor = 'bg-red-100 dark:bg-red-900';
                    textColor = 'text-red-700 dark:text-red-300';
                    break;
                case 'info':
                    bgColor = 'bg-blue-100 dark:bg-blue-900';
                    textColor = 'text-blue-700 dark:text-blue-300';
                    break;
                default:
                    bgColor = 'bg-gray-100 dark:bg-gray-700';
                    textColor = 'text-gray-800 dark:text-gray-200';
            }

            messageBox.className = `block mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 ${bgColor} ${textColor}`;
            messageBox.innerHTML = message;
            messageBox.classList.remove('hidden');

            if (duration > 0) {
                setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                    setTimeout(() => messageBox.classList.add('hidden', 'opacity-100'), 300);
                }, duration);
            }
        }

        /* --- FIREBASE/LOCAL DATA FUNCTIONS --- */

        /**
         * Reads all assignments from local storage.
         */
        function getAssignmentsFromLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Error reading from local storage:", error);
                return [];
            }
        }
        
        /**
         * Updates the UI with counts based on the assignment list.
         */
        function updateDashboardMetrics(assignments) {
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            let upcoming = 0;
            let completed = 0;
            let overdue = 0;

            assignments.forEach(a => {
                if (a.isCompleted) {
                    completed++;
                } else {
                    const dueDate = new Date(a.dueDate);
                    if (dueDate < now) {
                        overdue++;
                    } else {
                        upcoming++;
                    }
                }
            });

            upcomingCount.textContent = upcoming;
            completedCount.textContent = completed;
            overdueCount.textContent = overdue;
        }

        /**
         * Sets up the real-time listener for Firestore assignments.
         */
        function startFirestoreListener() {
            const assignmentsCol = collection(db, `artifacts/${appId}/public/data/assignments`);

            onSnapshot(assignmentsCol, (snapshot) => {
                const assignments = [];
                snapshot.forEach(doc => {
                    assignments.push({ id: doc.id, ...doc.data() });
                });
                updateDashboardMetrics(assignments);
                statusMessage.textContent = 'Data synchronized.';
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                statusMessage.textContent = 'Error fetching real-time data.';
                showMessage("Error loading data from database.", "error");
            });
        }
        
        /**
         * Local Mode Data Listener
         */
        function startLocalModeListener() {
            const assignments = getAssignmentsFromLocal();
            updateDashboardMetrics(assignments);
            statusMessage.textContent = 'Data loaded from Local Storage.';
        }


        /* --- INITIALIZATION --- */

        /**
         * Initializes Firebase or falls back to Local Mode.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                isLocalMode = true;
                console.warn("Firebase configuration missing. Switching to Local Mode.");
                startLocalModeListener();
                userIdDisplay.textContent = 'LOCAL_MODE';
                showMessage("Database connection missing. Using Local Storage.", "info", 5000);
            } else {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    const auth = getAuth(app);
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    isAuthReady = true;
                    const userId = auth.currentUser?.uid || 'Anonymous';
                    userIdDisplay.textContent = userId;

                    console.log("Firebase initialized and ready. Starting Firestore listener.");
                    startFirestoreListener();
                    
                } catch (error) {
                    console.error("Firebase initialization failed, falling back to Local Mode:", error);
                    isLocalMode = true;
                    isAuthReady = true;
                    userIdDisplay.textContent = 'ANON_FAIL';
                    startLocalModeListener();
                    showMessage("Database connection failed. Data loaded from Local Storage.", "info", 5000);
                }
            }
        }
        
        // Handle Dark Mode preference on load
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.documentElement.classList.add('dark');
        }

        // Initialize the app on load
        initializeFirebase();

    </script>
</body>
</html>
