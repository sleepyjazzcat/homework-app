<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Academic Dashboard</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        // Tailwind Configuration
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "card-light": "#ffffff",
                        "card-dark": "#1b2734",
                    },
                    fontFamily: {
                        "display": ["Lexend"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
        }
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">
    <div class="flex flex-col min-h-screen">
        <header class="bg-background-light dark:bg-background-dark sticky top-0 z-10 shadow-sm border-b border-slate-200 dark:border-slate-700">
            <div class="p-4 flex items-center justify-center">
                <h1 class="text-xl font-bold text-slate-900 dark:text-white">Academic Planner</h1>
            </div>
        </header>

        <div id="message-box" class="hidden mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300"></div>

        <main class="flex-1 px-4 py-6 space-y-6 overflow-y-auto">
            
            <a href="add-assignments.html" class="block bg-primary text-white p-6 rounded-xl shadow-lg border border-slate-100 dark:border-slate-700 space-y-2 hover:bg-blue-600 transition-colors">
                <div class="flex items-center justify-center gap-4">
                    <span class="material-symbols-outlined text-4xl font-light">add_circle</span>
                    <h2 class="text-2xl font-bold">Add New Assignment</h2>
                </div>
                <p class="text-sm text-center opacity-90">Manually input details for a new task or exam.</p>
            </a>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-card-light dark:bg-slate-800 p-4 rounded-xl shadow-md border border-slate-100 dark:border-slate-700">
                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Upcoming Tasks</p>
                    <p id="total-upcoming" class="text-3xl font-extrabold text-primary">--</p>
                </div>
                <div class="bg-card-light dark:bg-slate-800 p-4 rounded-xl shadow-md border border-slate-100 dark:border-slate-700">
                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Next Due Date</p>
                    <p id="next-due" class="text-3xl font-extrabold text-slate-900 dark:text-white">--</p>
                </div>
            </div>

            <div class="space-y-3">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Due Soon</h2>
                <div id="upcoming-assignments-list" class="space-y-3">
                    <p class="text-center text-slate-500 dark:text-slate-400 p-4">Loading assignments...</p>
                </div>
                <a class="block text-center text-sm font-medium text-primary hover:text-blue-600 transition-colors pt-2" href="assignments.html">
                    View All Assignments <span class="material-symbols-outlined text-base align-text-bottom">arrow_forward</span>
                </a>
            </div>

        </main>

        <footer class="bg-card-light dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 sticky bottom-0 z-10">
            <nav class="flex justify-around p-2">
                <a class="flex flex-col items-center justify-center gap-1 text-primary w-1/4" href="dashboard.html">
                    <span class="material-symbols-outlined">home</span>
                    <span class="text-xs font-medium">Dashboard</span>
                </a>
                <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="assignments.html">
                    <span class="material-symbols-outlined">list_alt</span>
                    <span class="text-xs font-medium">Assignments</span>
                </a>
                <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="index.html">
                    <span class="material-symbols-outlined">calendar_month</span>
                    <span class="text-xs font-medium">Calendar</span>
                </a>
                <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="settings.html">
                    <span class="material-symbols-outlined">settings</span>
                    <span class="text-xs font-medium">settings</span>
                </a>
            </nav>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('Debug');

        // Global Firebase variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let isAuthReady = false;

        // UI elements
        const messageBox = document.getElementById('message-box');
        const totalUpcoming = document.getElementById('total-upcoming');
        const nextDue = document.getElementById('next-due');
        const upcomingAssignmentsList = document.getElementById('upcoming-assignments-list');
        
        /**
         * Utility function to display messages.
         */
        function showMessage(message, type, duration = 3000) {
            let bgColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 dark:bg-green-900';
                    textColor = 'text-green-700 dark:text-green-300';
                    break;
                case 'error':
                    bgColor = 'bg-red-100 dark:bg-red-900';
                    textColor = 'text-red-700 dark:text-red-300';
                    break;
                case 'info':
                    bgColor = 'bg-blue-100 dark:bg-blue-900';
                    textColor = 'text-blue-700 dark:text-blue-300';
                    break;
                default:
                    bgColor = 'bg-gray-100 dark:bg-gray-700';
                    textColor = 'text-gray-800 dark:text-gray-200';
            }

            messageBox.className = `block mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 ${bgColor} ${textColor}`;
            messageBox.innerHTML = message;
            messageBox.classList.remove('hidden');

            if (duration > 0) {
                setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                    setTimeout(() => messageBox.classList.add('hidden', 'opacity-100'), 300);
                }, duration);
            }
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                showMessage("Database connection failed. Configuration missing.", "error");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                isAuthReady = true;
                console.log("Firebase initialized.");

                startRealtimeAssignmentListener();
                
            } catch (error) {
                console.error("Firebase initialization or authentication error:", error);
                showMessage("Authentication failed. Cannot load dashboard data.", "error");
            }
        }

        /**
         * Returns the Firestore collection path for public assignments.
         */
        function getAssignmentsCollection() {
            if (!db || !isAuthReady) {
                return null;
            }
            // Public collection path for shared data
            return collection(db, `artifacts/${appId}/public/data/assignments`);
        }
        
        /**
         * Sets up the real-time listener for assignments summary data.
         */
        function startRealtimeAssignmentListener() {
            const assignmentsCol = getAssignmentsCollection();
            if (!assignmentsCol) return;

            // Query for all assignments to filter and summarize locally
            const q = query(assignmentsCol);

            onSnapshot(q, (snapshot) => {
                const allAssignments = [];
                snapshot.forEach(doc => {
                    allAssignments.push({ id: doc.id, ...doc.data() });
                });
                
                updateDashboardSummary(allAssignments);

            }, (error) => {
                console.error("Error fetching assignments for dashboard:", error);
                showMessage("Failed to load assignment summary.", "error");
            });
        }

        /**
         * Updates the summary cards and the upcoming list.
         */
        function updateDashboardSummary(assignments) {
            // 1. Filter and sort upcoming assignments
            const upcoming = assignments.filter(a => !a.isCompleted).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            // 2. Update Total Upcoming Tasks
            totalUpcoming.textContent = upcoming.length;

            // 3. Update Next Due Date
            if (upcoming.length > 0) {
                const nextAssignment = upcoming[0];
                const dueDate = new Date(nextAssignment.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize today to midnight for comparison

                const timeDiff = dueDate.getTime() - today.getTime();
                const daysUntil = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                
                nextDue.classList.remove('text-red-500', 'text-orange-500', 'text-slate-900', 'dark:text-white');

                if (daysUntil < 0) {
                    nextDue.textContent = "Overdue!";
                    nextDue.classList.add('text-red-500');
                } else if (daysUntil === 0) {
                    nextDue.textContent = "Today!";
                    nextDue.classList.add('text-orange-500');
                } else if (daysUntil === 1) {
                    nextDue.textContent = "Tomorrow!";
                    nextDue.classList.add('text-orange-500');
                } else {
                    nextDue.textContent = `${daysUntil} days`;
                    nextDue.classList.add('text-slate-900', 'dark:text-white');
                }
            } else {
                nextDue.textContent = "None!";
                nextDue.classList.remove('text-red-500', 'text-orange-500');
                nextDue.classList.add('text-slate-900', 'dark:text-white');
            }

            // 4. Render top 3 upcoming assignments
            upcomingAssignmentsList.innerHTML = '';
            const assignmentsToDisplay = upcoming.slice(0, 3);
            
            if (assignmentsToDisplay.length === 0) {
                 upcomingAssignmentsList.innerHTML = '<p class="text-center text-slate-500 dark:text-slate-400 p-4">All caught up! Nothing due soon.</p>';
            } else {
                assignmentsToDisplay.forEach(a => {
                    // Using toLocaleDateString() for a cleaner display format
                    const dueDate = new Date(a.dueDate).toLocaleDateString();
                    const card = document.createElement('a');
                    card.href = `assignments.html?id=${a.id}`;
                    card.className = "block bg-card-light dark:bg-slate-700 p-3 rounded-lg hover:shadow-lg transition-shadow border border-slate-200 dark:border-slate-600";
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-slate-900 dark:text-white truncate">${a.title}</p>
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full text-white ${a.priority === 'High' ? 'bg-red-500' : (a.priority === 'Medium' ? 'bg-orange-500' : 'bg-slate-500')}">${a.priority || 'Low'}</span>
                        </div>
                        <p class="text-sm text-primary mt-1">${a.course}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Due: ${dueDate}</p>
                    `;
                    upcomingAssignmentsList.appendChild(card);
                });
            }
        }

        // Initialize Firebase on load
        initializeFirebase();
    </script>
</body>
</html>
```eof
