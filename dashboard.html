<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Academic Dashboard</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        // Tailwind Configuration
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "card-light": "#ffffff",
                        "card-dark": "#1b2734",
                        "accent-red": "#ef4444",
                        "accent-green": "#10b981",
                        "accent-blue": "#3b82f6",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
        }
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
        .priority-high {
            border-left-color: theme('colors.accent-red');
        }
        .priority-medium {
            border-left-color: theme('colors.primary');
        }
        .priority-low {
            border-left-color: theme('colors.accent-green');
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-card-light dark:bg-card-dark sticky top-0 z-10 shadow-md border-b border-slate-200 dark:border-slate-700">
        <div class="p-4 flex items-center justify-between">
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">Academic Dashboard</h1>
            <p id="connection-status" class="text-xs font-medium text-slate-500 dark:text-slate-400">Loading...</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-4 overflow-y-auto space-y-6">

        <!-- Quick Stats Cards -->
        <div class="grid grid-cols-3 gap-3">
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md text-center">
                <p id="total-count" class="text-2xl font-bold text-primary">--</p>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Total</p>
            </div>
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md text-center">
                <p id="upcoming-count" class="text-2xl font-bold text-accent-blue">--</p>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Upcoming</p>
            </div>
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md text-center">
                <p id="completed-count" class="text-2xl font-bold text-accent-green">--</p>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Completed</p>
            </div>
        </div>
        
        <!-- Quick Action: Add New Assignment -->
        <a href="add-assignments.html" class="block">
            <div class="bg-primary hover:bg-blue-600 transition-colors text-white p-4 rounded-xl shadow-lg flex items-center justify-center space-x-3 cursor-pointer">
                <span class="material-symbols-outlined text-3xl">add_circle</span>
                <span class="text-lg font-semibold">Add New Assignment</span>
            </div>
        </a>

        <!-- Urgent Assignments Section -->
        <section class="space-y-4">
            <h2 class="text-lg font-bold text-slate-900 dark:text-white">Top 5 Urgent Tasks</h2>
            <div id="urgent-assignments-list" class="space-y-3">
                <!-- Assignments will be rendered here -->
                <p class="text-center text-slate-500 dark:text-slate-400 p-4">Loading assignments...</p>
            </div>
        </section>
        
        <!-- Message Box for Feedback -->
        <div id="message-box" class="mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 hidden"></div>

    </main>

    <!-- Footer Navigation (Consistent with other pages) -->
    <footer class="bg-card-light dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 sticky bottom-0 z-10">
        <nav class="flex justify-around p-2">
            <a class="flex flex-col items-center justify-center gap-1 text-primary w-1/4" href="dashboard.html">
                <span class="material-symbols-outlined">home</span>
                <span class="text-xs font-medium">Dashboard</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="assignments.html">
                <span class="material-symbols-outlined">list_alt</span>
                <span class="text-xs font-medium">Assignments</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="index.html">
                <span class="material-symbols-outlined">calendar_month</span>
                <span class="text-xs font-medium">Calendar</span>
            </a>
            <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="settings.html">
                <span class="material-symbols-outlined">settings</span>
                <span class="text-xs font-medium">Settings</span>
            </a>
        </nav>
    </footer>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Application State
        let db = null;
        let isLocalMode = false;
        let isAuthReady = false;
        const LOCAL_STORAGE_KEY = `academicPlanner_assignments_${appId}`;
        const priorityOrder = { 'High': 1, 'Medium': 2, 'Low': 3 };

        // UI Elements
        const totalCountEl = document.getElementById('total-count');
        const upcomingCountEl = document.getElementById('upcoming-count');
        const completedCountEl = document.getElementById('completed-count');
        const urgentListEl = document.getElementById('urgent-assignments-list');
        const connectionStatusEl = document.getElementById('connection-status');

        /* --- UTILITY FUNCTIONS --- */

        /**
         * Reads all assignments from local storage.
         */
        function getAssignmentsFromLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Error reading from local storage:", error);
                return [];
            }
        }
        
        /**
         * Formats a date string for display.
         */
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        /**
         * Renders the urgent list item for one assignment.
         */
        function renderUrgentItem(assignment) {
            const priorityClass = `priority-${assignment.priority.toLowerCase()}`;
            
            return `
                <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border-l-4 ${priorityClass} flex items-center justify-between transition-shadow hover:shadow-lg">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold truncate text-slate-900 dark:text-white">${assignment.title}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">${assignment.course}</p>
                    </div>
                    <div class="text-right ml-4">
                        <p class="text-sm font-bold text-slate-700 dark:text-slate-300">${formatDate(assignment.dueDate)}</p>
                        <p class="text-xs font-medium mt-0.5 
                            ${assignment.priority === 'High' ? 'text-accent-red' : assignment.priority === 'Medium' ? 'text-primary' : 'text-accent-green'}">
                            ${assignment.priority}
                        </p>
                    </div>
                </div>
            `;
        }

        /* --- DATA PROCESSING AND RENDERING --- */

        /**
         * Calculates stats and renders the dashboard UI.
         */
        function calculateStatsAndRender(assignments) {
            const now = new Date();
            const todayDateString = now.toISOString().split('T')[0];
            
            const upcoming = assignments.filter(a => 
                !a.isCompleted && a.dueDate >= todayDateString
            );
            const completed = assignments.filter(a => a.isCompleted);

            // Sort upcoming assignments: 1. High Priority, 2. Closest Due Date
            const urgentAssignments = upcoming.sort((a, b) => {
                // Primary sort: Priority (High=1, Medium=2, Low=3)
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                // Secondary sort: Due Date (closer date first)
                return new Date(a.dueDate) - new Date(b.dueDate);
            }).slice(0, 5); // Take top 5

            // Render Stats
            totalCountEl.textContent = assignments.length;
            upcomingCountEl.textContent = upcoming.length;
            completedCountEl.textContent = completed.length;

            // Render Urgent List
            if (urgentAssignments.length === 0) {
                urgentListEl.innerHTML = `<p class="text-center text-slate-500 dark:text-slate-400 p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-md">No urgent assignments! Enjoy the break.</p>`;
            } else {
                urgentListEl.innerHTML = urgentAssignments.map(renderUrgentItem).join('');
            }
        }

        /* --- INITIALIZATION --- */

        /**
         * Main function to fetch data and listen for updates (Local or Database).
         */
        function setupDataListener() {
            if (!isAuthReady) return;

            if (isLocalMode) {
                // --- LOCAL MODE ---
                connectionStatusEl.textContent = 'Local Mode';
                connectionStatusEl.classList.add('text-orange-600', 'dark:text-orange-400');
                
                const assignments = getAssignmentsFromLocal();
                calculateStatsAndRender(assignments);
                
                // Note: Local mode requires refreshing the page to see new data, 
                // unlike Firestore's onSnapshot.

            } else {
                // --- DATABASE MODE (Firebase) ---
                connectionStatusEl.textContent = 'Database Connected';
                connectionStatusEl.classList.add('text-green-600', 'dark:text-green-400');

                const assignmentsColRef = collection(db, `artifacts/${appId}/public/data/assignments`);
                const q = query(assignmentsColRef);
                
                // Real-time listener
                onSnapshot(q, (snapshot) => {
                    const assignments = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data(),
                        // Ensure required fields for rendering are present
                        isCompleted: doc.data().isCompleted || false,
                        priority: doc.data().priority || 'Medium',
                        dueDate: doc.data().dueDate || new Date().toISOString().split('T')[0]
                    }));
                    
                    calculateStatsAndRender(assignments);
                }, (error) => {
                    console.error("Firestore error:", error);
                    connectionStatusEl.textContent = 'DB Failed (Check console)';
                    connectionStatusEl.classList.add('text-red-600', 'dark:text-red-400');
                    // Fallback to local on connection error, though unlikely after auth succeeds
                    isLocalMode = true; 
                    setupDataListener(); // Try again in local mode
                });
            }
        }

        /**
         * Initializes Firebase or falls back to Local Mode.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                isLocalMode = true;
                isAuthReady = true;
                connectionStatusEl.textContent = 'Local Mode (No DB)';
                connectionStatusEl.classList.add('text-orange-600', 'dark:text-orange-400');
                setupDataListener(); // Start listening in local mode
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                isAuthReady = true;
                setupDataListener(); // Start listening in database mode

            } catch (error) {
                console.error("Firebase initialization failed, falling back to Local Mode:", error);
                isLocalMode = true;
                isAuthReady = true;
                connectionStatusEl.textContent = 'DB Failed/Local Mode';
                connectionStatusEl.classList.add('text-orange-600', 'dark:text-orange-400');
                setupDataListener(); // Start listening in local mode
            }
        }
        
        // Apply dark mode immediately on load
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.documentElement.classList.add('dark');
        }
        
        // Initialize the app
        initializeFirebase();

    </script>
</body>
</html>
