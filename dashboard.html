<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Academic Dashboard</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        // Tailwind Configuration
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "card-light": "#ffffff",
                        "card-dark": "#1b2734",
                    },
                    fontFamily: {
                        "display": ["Lexend"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
        }
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
        /* Custom spinner animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-background-light dark:bg-background-dark sticky top-0 z-10 shadow-sm border-b border-slate-200 dark:border-slate-700">
            <div class="p-4 flex items-center justify-center">
                <h1 class="text-xl font-bold text-slate-900 dark:text-white">Academic Planner</h1>
            </div>
        </header>

        <!-- Message Box for Feedback -->
        <div id="message-box" class="hidden mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300"></div>

        <!-- Main Content Area -->
        <main class="flex-1 px-4 py-6 space-y-6 overflow-y-auto">
            
            <!-- Sync Assignment Card -->
            <div class="bg-card-light dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-100 dark:border-slate-700 space-y-4">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Quick Sync</h2>
                <p class="text-sm text-slate-600 dark:text-slate-300">Use Gemini's grounding to search for and extract your latest assignments from public course pages or syllabi. It will automatically save them to your planner.</p>
                
                <input id="sync-prompt" class="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-background-light dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:ring-primary focus:border-primary" placeholder="e.g., Find assignments for CS 101 and History 205 syllabus" type="text" value="latest university course assignments"/>
                
                <button id="sync-button" class="w-full flex items-center justify-center gap-2 bg-primary text-white px-4 py-3 rounded-lg text-lg font-semibold shadow-md hover:bg-blue-600 transition-colors disabled:bg-gray-400">
                    <span class="material-symbols-outlined text-xl">sync</span>
                    <span id="sync-button-text">Sync Assignments Now</span>
                </button>
                <div id="sync-status" class="text-sm text-slate-600 dark:text-slate-400"></div>
            </div>

            <!-- Summary Metrics -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-card-light dark:bg-slate-800 p-4 rounded-xl shadow-md border border-slate-100 dark:border-slate-700">
                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Upcoming Tasks</p>
                    <p id="total-upcoming" class="text-3xl font-extrabold text-primary">--</p>
                </div>
                <div class="bg-card-light dark:bg-slate-800 p-4 rounded-xl shadow-md border border-slate-100 dark:border-slate-700">
                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Next Due Date</p>
                    <p id="next-due" class="text-3xl font-extrabold text-slate-900 dark:text-white">--</p>
                </div>
            </div>

            <!-- Upcoming Assignments List -->
            <div class="space-y-3">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Due Soon</h2>
                <div id="upcoming-assignments-list" class="space-y-3">
                    <p class="text-center text-slate-500 dark:text-slate-400 p-4">Loading assignments...</p>
                </div>
                <a class="block text-center text-sm font-medium text-primary hover:text-blue-600 transition-colors pt-2" href="assignments.html">
                    View All Assignments <span class="material-symbols-outlined text-base align-text-bottom">arrow_forward</span>
                </a>
            </div>

        </main>

        <!-- Footer Navigation (Consistent with other pages) -->
        <footer class="bg-card-light dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 sticky bottom-0 z-10">
            <nav class="flex justify-around p-2">
                <!-- Dashboard Link (Active) -->
                <a class="flex flex-col items-center justify-center gap-1 text-primary w-1/4" href="dashboard.html">
                    <span class="material-symbols-outlined">home</span>
                    <span class="text-xs font-medium">Dashboard</span>
                </a>
                <!-- Assignments Link -->
                <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="assignments.html">
                    <span class="material-symbols-outlined">list_alt</span>
                    <span class="text-xs font-medium">Assignments</span>
                </a>
                <!-- Calendar Link -->
                <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="index.html">
                    <span class="material-symbols-outlined">calendar_month</span>
                    <span class="text-xs font-medium">Calendar</span>
                </a>
                <!-- Settings Link -->
                <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="settings.html">
                    <span class="material-symbols-outlined">settings</span>
                    <span class="text-xs font-medium">settings</span>
                </a>
            </nav>
        </footer>
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('Debug');

        // Global Firebase variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // UI elements
        const messageBox = document.getElementById('message-box');
        const syncButton = document.getElementById('sync-button');
        const syncButtonText = document.getElementById('sync-button-text');
        const syncPrompt = document.getElementById('sync-prompt');
        const syncStatus = document.getElementById('sync-status');
        const totalUpcoming = document.getElementById('total-upcoming');
        const nextDue = document.getElementById('next-due');
        const upcomingAssignmentsList = document.getElementById('upcoming-assignments-list');
        
        // LLM API Constants
        const GEMINI_MODEL = "gemini-2.5-flash-preview-05-20";
        const API_KEY = ""; // Provided by the environment at runtime

        /**
         * Utility function to display messages.
         */
        function showMessage(message, type, duration = 3000) {
            let bgColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 dark:bg-green-900';
                    textColor = 'text-green-700 dark:text-green-300';
                    break;
                case 'error':
                    bgColor = 'bg-red-100 dark:bg-red-900';
                    textColor = 'text-red-700 dark:text-red-300';
                    break;
                case 'info':
                    bgColor = 'bg-blue-100 dark:bg-blue-900';
                    textColor = 'text-blue-700 dark:text-blue-300';
                    break;
                default:
                    bgColor = 'bg-gray-100 dark:bg-gray-700';
                    textColor = 'text-gray-800 dark:text-gray-200';
            }

            messageBox.className = `block mx-4 mt-4 p-3 rounded-lg text-sm font-medium transition-opacity duration-300 ${bgColor} ${textColor}`;
            messageBox.innerHTML = message;
            messageBox.classList.remove('hidden');

            if (duration > 0) {
                setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                    setTimeout(() => messageBox.classList.add('hidden', 'opacity-100'), 300);
                }, duration);
            }
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                showMessage("Database connection failed. Configuration missing.", "error");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || crypto.randomUUID();
                isAuthReady = true;
                console.log("Firebase initialized. User ID:", userId);

                startRealtimeAssignmentListener();
                
            } catch (error) {
                console.error("Firebase initialization or authentication error:", error);
                showMessage("Authentication failed. Cannot load dashboard data.", "error");
            }
        }

        /**
         * Returns the Firestore collection path for public assignments.
         */
        function getAssignmentsCollection() {
            if (!db || !isAuthReady) {
                return null;
            }
            // Public collection path for shared data
            return collection(db, `artifacts/${appId}/public/data/assignments`);
        }
        
        /**
         * Sets up the real-time listener for assignments summary data.
         */
        function startRealtimeAssignmentListener() {
            const assignmentsCol = getAssignmentsCollection();
            if (!assignmentsCol) return;

            // Query for all assignments to filter and summarize locally
            const q = query(assignmentsCol);

            onSnapshot(q, (snapshot) => {
                const allAssignments = [];
                snapshot.forEach(doc => {
                    allAssignments.push({ id: doc.id, ...doc.data() });
                });
                
                updateDashboardSummary(allAssignments);

            }, (error) => {
                console.error("Error fetching assignments for dashboard:", error);
                showMessage("Failed to load assignment summary.", "error");
            });
        }

        /**
         * Updates the summary cards and the upcoming list.
         */
        function updateDashboardSummary(assignments) {
            const upcoming = assignments.filter(a => !a.isCompleted).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            totalUpcoming.textContent = upcoming.length;

            if (upcoming.length > 0) {
                const nextAssignment = upcoming[0];
                const dueDate = new Date(nextAssignment.dueDate);
                const daysUntil = Math.ceil((dueDate.getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));
                
                if (daysUntil < 0) {
                    nextDue.textContent = "Overdue!";
                    nextDue.classList.add('text-red-500');
                    nextDue.classList.remove('text-slate-900', 'dark:text-white');
                } else if (daysUntil === 0) {
                    nextDue.textContent = "Today!";
                    nextDue.classList.add('text-orange-500');
                    nextDue.classList.remove('text-slate-900', 'dark:text-white');
                } else {
                    nextDue.textContent = `${daysUntil} days`;
                    nextDue.classList.remove('text-red-500', 'text-orange-500');
                    nextDue.classList.add('text-slate-900', 'dark:text-white');
                }
            } else {
                nextDue.textContent = "None!";
                nextDue.classList.remove('text-red-500', 'text-orange-500');
                nextDue.classList.add('text-slate-900', 'dark:text-white');
            }

            // Render top 3 upcoming assignments
            upcomingAssignmentsList.innerHTML = '';
            const assignmentsToDisplay = upcoming.slice(0, 3);
            
            if (assignmentsToDisplay.length === 0) {
                 upcomingAssignmentsList.innerHTML = '<p class="text-center text-slate-500 dark:text-slate-400 p-4">All caught up! Nothing due soon.</p>';
            } else {
                assignmentsToDisplay.forEach(a => {
                    const dueDate = new Date(a.dueDate).toLocaleDateString();
                    const card = document.createElement('a');
                    card.href = `assignments.html?id=${a.id}`;
                    card.className = "block bg-card-light dark:bg-slate-700 p-3 rounded-lg hover:shadow-lg transition-shadow border border-slate-200 dark:border-slate-600";
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-slate-900 dark:text-white truncate">${a.title}</p>
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full text-white ${a.priority === 'High' ? 'bg-red-500' : (a.priority === 'Medium' ? 'bg-orange-500' : 'bg-slate-500')}">${a.priority || 'Low'}</span>
                        </div>
                        <p class="text-sm text-primary mt-1">${a.course}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Due: ${dueDate}</p>
                    `;
                    upcomingAssignmentsList.appendChild(card);
                });
            }
        }


        /**
         * Calls the Gemini API to search and extract structured assignment data.
         */
        async function syncAssignments() {
            if (!isAuthReady) {
                showMessage("Authentication not ready. Please wait.", "error");
                return;
            }
            
            syncButton.disabled = true;
            syncButtonText.innerHTML = '<div class="spinner mr-2"></div> Syncing...';
            syncStatus.textContent = "Searching the web and analyzing results...";
            showMessage("Starting assignment sync...", "info", 5000);

            const userQuery = syncPrompt.value;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;

            // Define the JSON schema for the expected structured output
            const ASSIGNMENT_SCHEMA = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "title": { "type": "STRING", "description": "The name of the assignment." },
                        "course": { "type": "STRING", "description": "The course code or name (e.g., CS 101)." },
                        "dueDate": { "type": "STRING", "description": "The exact due date in ISO 8601 format (e.g., YYYY-MM-DDTHH:MM:SSZ)." },
                        "description": { "type": "STRING", "description": "A brief description of the task." },
                        "priority": { "type": "STRING", "description": "The priority level (High, Medium, or Low)." }
                    },
                    required: ["title", "course", "dueDate", "description"]
                }
            };

            const systemPrompt = `You are a sophisticated academic planner assistant. Your task is to analyze the provided Google Search results (which may contain syllabi, course websites, or academic calendars) and accurately extract all upcoming assignments, projects, or exams. You MUST return the results as a JSON array strictly conforming to the provided schema. Infer the 'priority' based on complexity or due date proximity (e.g., within 3 days is High). All dates must be in full ISO 8601 format (YYYY-MM-DDTHH:MM:SSZ).`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: ASSIGNMENT_SCHEMA
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API returned status ${response.status}`);
                }
                
                const result = await response.json();
                
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                    throw new Error("No structured content returned by the model.");
                }

                syncStatus.textContent = "Processing and saving new assignments...";
                const assignments = JSON.parse(jsonText);
                
                await saveAssignmentsToFirestore(assignments);

                showMessage(`Successfully synced and added ${assignments.length} assignments!`, "success");

            } catch (error) {
                console.error("Assignment Sync Error:", error);
                showMessage(`Sync failed: ${error.message}. See console for details.`, "error");
            } finally {
                syncButton.disabled = false;
                syncButtonText.textContent = 'Sync Assignments Now';
                syncStatus.textContent = "Sync complete. Check the list below for updates.";
            }
        }

        /**
         * Saves extracted assignments to Firestore, checking for duplicates.
         */
        async function saveAssignmentsToFirestore(assignments) {
            if (!assignments || assignments.length === 0) return 0;
            const assignmentsCol = getAssignmentsCollection();
            if (!assignmentsCol) return 0;

            let addedCount = 0;
            
            for (const assignment of assignments) {
                // Create a basic unique key for deduplication (Title + Course)
                const uniqueKey = `${assignment.title.trim()}_${assignment.course.trim()}`;
                
                // Fetch existing documents to check for key existence (simplistic check)
                // NOTE: In a real app, you'd use a more robust compound query if Firestore allowed it without complex indexing.
                const existingQuery = query(assignmentsCol);
                const existingSnapshot = await getDocs(existingQuery);
                let isDuplicate = false;

                existingSnapshot.forEach(doc => {
                    const data = doc.data();
                    const existingKey = `${data.title.trim()}_${data.course.trim()}`;
                    if (existingKey === uniqueKey && !data.isCompleted) {
                        isDuplicate = true;
                    }
                });

                if (isDuplicate) {
                    console.log(`Skipping duplicate assignment: ${assignment.title}`);
                    continue;
                }

                // Add necessary fields for the planner
                const newAssignment = {
                    ...assignment,
                    isCompleted: false,
                    createdAt: new Date().toISOString(),
                    // Ensure dates are valid ISO strings, remove unnecessary Timezone info if present
                    dueDate: assignment.dueDate.split('.')[0].replace('Z', '') + 'Z', 
                };

                try {
                    await addDoc(assignmentsCol, newAssignment);
                    addedCount++;
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            }
            return addedCount;
        }

        // Event Listeners
        syncButton.addEventListener('click', syncAssignments);

        // Initialize Firebase on load
        initializeFirebase();
    </script>
</body>
</html>
