<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>My Assignments</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        // Tailwind Configuration
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "card-light": "#ffffff",
                        "card-dark": "#1b2734",
                        "input-light": "#eef1f4",
                        "input-dark": "#2a3b4c",
                        "tag-creative": "#4ade80", // Green
                        "tag-test-prep": "#f87171", // Red
                        "tag-online-weekly": "#38bdf8", // Sky Blue
                        "tag-reading": "#fbbf24", // Amber
                        "tag-project": "#a78bfa", // Violet
                        "tag-other": "#9ca3af", // Gray
                    },
                    fontFamily: {
                        "display": ["Lexend"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
        }
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
        /* Custom modal transition styles */
        .modal-enter-active, .modal-leave-active {
            transition: opacity 0.3s ease;
        }
        .modal-enter-from, .modal-leave-to {
            opacity: 0;
        }
        .modal-enter-active .modal-content, .modal-leave-active .modal-content {
            transition: transform 0.3s ease;
        }
        .modal-enter-from .modal-content, .modal-leave-to .modal-content {
            transform: translateY(100%);
        }
        .tag-pill {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 9999px;
            color: #101922; /* Always dark text for contrast on bright pills */
            text-transform: uppercase;
            white-space: nowrap;
        }
        .tag-creative { background-color: #4ade80; }
        .tag-test-prep { background-color: #f87171; }
        .tag-online-weekly { background-color: #38bdf8; }
        .tag-reading { background-color: #fbbf24; }
        .tag-project { background-color: #a78bfa; }
        .tag-other { background-color: #d1d5db; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-background-light dark:bg-background-dark sticky top-0 z-10 shadow-sm border-b border-slate-200 dark:border-slate-700">
            <div class="p-4 flex items-center justify-between">
                <h1 class="text-xl font-bold text-slate-900 dark:text-white">All Assignments</h1>
                <a href="add-assignments.html" class="p-1.5 bg-primary text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors">
                    <span class="material-symbols-outlined text-2xl">add</span>
                </a>
            </div>
        </header>

        <!-- Loading Indicator & Connection Status -->
        <div id="loading-indicator" class="p-4 text-center">
            <span class="text-slate-500 dark:text-slate-400">Loading assignments...</span>
        </div>
        <div id="connection-status" class="mx-4 mt-2 p-2 rounded-lg text-sm text-center font-medium"></div>

        <!-- Filter Buttons -->
        <div class="flex justify-start gap-2 p-4 pt-2 overflow-x-auto border-b border-slate-200 dark:border-slate-700">
            <button data-filter="All" class="filter-btn bg-primary text-white text-sm px-4 py-2 rounded-full font-medium shadow-md">All</button>
            <button data-filter="Upcoming" class="filter-btn bg-card-light dark:bg-card-dark text-slate-700 dark:text-slate-200 text-sm px-4 py-2 rounded-full font-medium hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Upcoming</button>
            <button data-filter="Completed" class="filter-btn bg-card-light dark:bg-card-dark text-slate-700 dark:text-slate-200 text-sm px-4 py-2 rounded-full font-medium hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Completed</button>
        </div>

        <!-- Assignment List -->
        <main class="flex-1 px-4 py-4 space-y-3 overflow-y-auto">
            <div id="assignment-list">
                <!-- Assignments will be rendered here -->
            </div>
        </main>

        <!-- Footer Navigation (Consistent with other pages) -->
        <footer class="bg-card-light dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 sticky bottom-0 z-10">
            <nav class="flex justify-around p-2">
                <!-- Dashboard Link -->
                <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="dashboard.html">
                    <span class="material-symbols-outlined">home</span>
                    <span class="text-xs font-medium">Dashboard</span>
                </a>
                <!-- Assignments Link (Active) -->
                <a class="flex flex-col items-center justify-center gap-1 text-primary w-1/4" href="assignments.html">
                    <span class="material-symbols-outlined">list_alt</span>
                    <span class="text-xs font-medium">Assignments</span>
                </a>
                <!-- Calendar Link -->
                <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="index.html">
                    <span class="material-symbols-outlined">calendar_month</span>
                    <span class="text-xs font-medium">Calendar</span>
                </a>
                <!-- Settings Link -->
                <a class="flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary w-1/4" href="settings.html">
                    <span class="material-symbols-outlined">settings</span>
                    <span class="text-xs font-medium">Settings</span>
                </a>
            </nav>
        </footer>

        <!-- Detail/Edit Modal -->
        <div id="detail-modal-wrapper" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 modal-enter-from" onclick="hideDetailView()">
            <div class="absolute bottom-0 w-full modal-content" onclick="event.stopPropagation()">
                <div id="detail-modal" class="bg-card-light dark:bg-card-dark rounded-t-xl p-6 shadow-2xl transition-transform transform translate-y-full">
                    <!-- Detail/Edit content will be injected here -->
                </div>
            </div>
        </div>

        <!-- Confirmation Modal (Delete) -->
        <div id="confirm-modal-wrapper" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center" onclick="hideConfirmModal()">
            <div class="bg-card-light dark:bg-card-dark rounded-xl p-6 shadow-2xl w-11/12 max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
                <p id="confirm-message" class="text-slate-600 dark:text-slate-400 mb-6">Are you sure you want to delete this assignment?</p>
                <div class="flex justify-end space-x-3">
                    <button class="px-4 py-2 text-sm font-medium rounded-lg text-slate-700 dark:text-slate-200 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors" onclick="hideConfirmModal()">Cancel</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-red-500 hover:bg-red-600 transition-colors">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, doc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('Debug');

        // Global Firebase variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let isAuthReady = false;
        let isLocalMode = false;
        let currentFilter = 'All'; // State for filtering

        // UI elements
        const loadingIndicatorEl = document.getElementById('loading-indicator');
        const assignmentListEl = document.getElementById('assignment-list');
        const connectionStatusEl = document.getElementById('connection-status');
        const detailModalWrapperEl = document.getElementById('detail-modal-wrapper');
        const detailModalEl = document.getElementById('detail-modal');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const confirmModalWrapperEl = document.getElementById('confirm-modal-wrapper');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        // --- Data Definitions ---
        const TAG_OPTIONS = [
            { value: "Creative", label: "Creative" },
            { value: "Test Preparation", label: "Test Preparation" },
            { value: "Online Weekly", label: "Online Weekly" },
            { value: "Reading", label: "Reading" },
            { value: "Project", label: "Project" },
            { value: "Other", label: "Other" }
        ];

        const PRIORITY_OPTIONS = [
            { value: "Low", label: "Low" },
            { value: "Medium", label: "Medium" },
            { value: "High", label: "High" }
        ];
        
        const COURSE_OPTIONS = [
            { value: "Mathematics", label: "Mathematics" },
            { value: "Science", label: "Science" },
            { value: "History", label: "History" },
            { value: "English", label: "English" },
            { value: "Art", label: "Art" },
            { value: "Other", label: "Other" }
        ];

        // --- Utility Functions ---

        function getTagClass(tag) {
            switch (tag) {
                case 'Creative': return 'tag-creative';
                case 'Test Preparation': return 'tag-test-prep';
                case 'Online Weekly': return 'tag-online-weekly';
                case 'Reading': return 'tag-reading';
                case 'Project': return 'tag-project';
                default: return 'tag-other';
            }
        }

        function getPriorityClass(priority) {
            switch (priority) {
                case 'High': return 'bg-red-500';
                case 'Medium': return 'bg-orange-500';
                default: return 'bg-slate-500';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            if (isNaN(date)) return 'N/A';
            return date.toLocaleDateString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        /**
         * Ensures all required fields are present in the assignment object
         */
        function normalizeAssignment(assignment) {
            return {
                ...assignment,
                tag: assignment.tag || 'Other', // Crucial fix for old local data
                description: assignment.description || '',
                isCompleted: assignment.isCompleted || false
            };
        }

        // --- Local Storage Functions (Fallback) ---

        const LOCAL_STORAGE_KEY = 'academic_assignments';

        function getAssignmentsFromLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                const assignments = data ? JSON.parse(data) : [];
                return assignments.map(normalizeAssignment); // Normalize old data on load
            } catch (e) {
                console.error("Error reading local storage:", e);
                return [];
            }
        }

        function saveAssignmentsToLocal(assignments) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(assignments));
                // Manually trigger render after save in local mode
                renderAssignments(filterAssignments(assignments, currentFilter));
            } catch (e) {
                console.error("Error writing to local storage:", e);
            }
        }

        function updateAssignmentInLocal(id, updates) {
            const assignments = getAssignmentsFromLocal();
            const index = assignments.findIndex(a => a.id === id);
            if (index !== -1) {
                assignments[index] = normalizeAssignment({ ...assignments[index], ...updates });
                saveAssignmentsToLocal(assignments);
            }
        }

        function deleteAssignmentInLocal(id) {
            const assignments = getAssignmentsFromLocal();
            const updatedAssignments = assignments.filter(a => a.id !== id);
            saveAssignmentsToLocal(updatedAssignments);
        }

        // --- Firestore Functions ---

        function getAssignmentsCollection() {
            if (!db || !isAuthReady || isLocalMode) return null;
            // Public collection path for shared data
            return collection(db, `artifacts/${appId}/public/data/assignments`);
        }

        async function updateAssignmentInFirestore(id, updates) {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/assignments`, id);
                await updateDoc(docRef, updates);
                console.log("Assignment updated successfully:", id);
            } catch (error) {
                console.error("Error updating assignment:", error);
                // Note: No alert() used, just console error
            }
        }

        async function deleteAssignmentInFirestore(id) {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/assignments`, id);
                await deleteDoc(docRef);
                console.log("Assignment deleted successfully:", id);
            } catch (error) {
                console.error("Error deleting assignment:", error);
                // Note: No alert() used, just console error
            }
        }

        // --- Core Application Logic ---

        /**
         * Filters assignments based on the current UI filter.
         */
        function filterAssignments(assignments, filter) {
            const now = new Date();
            now.setHours(0, 0, 0, 0); // Normalize time for comparison

            let filtered = assignments;

            if (filter === 'Upcoming') {
                filtered = assignments.filter(a => !a.isCompleted && new Date(a.dueDate) >= now);
            } else if (filter === 'Completed') {
                filtered = assignments.filter(a => a.isCompleted);
            }

            // Sort by due date (closest first)
            return filtered.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        }

        /**
         * Renders the list of assignments to the DOM.
         */
        function renderAssignments(assignments) {
            assignmentListEl.innerHTML = '';
            
            if (loadingIndicatorEl) {
                loadingIndicatorEl.classList.add('hidden');
            }

            if (assignments.length === 0) {
                const message = document.createElement('p');
                message.className = 'text-center text-slate-500 dark:text-slate-400 p-6';
                message.textContent = currentFilter === 'Completed' ? 'No assignments marked as completed.' : 'You have no assignments here yet. Use the "+" button to add one!';
                assignmentListEl.appendChild(message);
                return;
            }

            assignments.forEach(assignment => {
                const card = document.createElement('div');
                card.className = `flex items-center bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-md border border-slate-200 dark:border-slate-700 cursor-pointer transition-shadow hover:shadow-lg ${assignment.isCompleted ? 'opacity-70 line-through' : ''}`;
                card.onclick = () => showDetailView(assignment.id);
                
                const dueDate = formatDate(assignment.dueDate);
                const tagClass = getTagClass(assignment.tag);
                const priorityClass = getPriorityClass(assignment.priority);

                card.innerHTML = `
                    <div class="flex-shrink-0 w-2 h-14 rounded-full mr-4 ${priorityClass}"></div>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-lg truncate">${assignment.title}</p>
                        <p class="text-sm text-slate-500 dark:text-slate-400">${assignment.course}</p>
                        <div class="flex items-center space-x-2 mt-1">
                            <span class="tag-pill ${tagClass}">${assignment.tag}</span>
                            <span class="text-xs font-medium text-slate-500 dark:text-slate-400">Due: ${dueDate}</span>
                        </div>
                    </div>
                    <div class="flex-shrink-0 ml-4">
                        <button class="text-primary hover:text-blue-600 p-2 rounded-full transition-colors" onclick="event.stopPropagation(); toggleCompletion('${assignment.id}', ${!assignment.isCompleted})">
                            <span class="material-symbols-outlined">${assignment.isCompleted ? 'check_box' : 'check_box_outline_blank'}</span>
                        </button>
                    </div>
                `;
                assignmentListEl.appendChild(card);
            });
        }

        /**
         * Toggles the completion status of an assignment.
         */
        window.toggleCompletion = async function(id, isCompleted) {
            const updates = { isCompleted: isCompleted };
            
            if (isLocalMode) {
                updateAssignmentInLocal(id, updates);
            } else {
                await updateAssignmentInFirestore(id, updates);
            }
        };

        // --- Detail View / Modal Logic ---

        function renderDetailModal(assignment) {
            const dueDate = assignment.dueDate; // YYYY-MM-DD format for input
            const priorityClass = getPriorityClass(assignment.priority);
            const tagClass = getTagClass(assignment.tag);

            detailModalEl.innerHTML = `
                <div id="detail-view" class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-extrabold truncate w-4/5">${assignment.title}</h2>
                        <div class="flex space-x-2">
                            <button class="text-slate-500 dark:text-slate-400 hover:text-red-500 transition-colors" onclick="showConfirmModal('${assignment.id}')">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                            <button class="text-primary hover:text-blue-600 transition-colors" onclick="switchToEditView('${assignment.id}')">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                            <button class="text-slate-500 dark:text-slate-400 hover:text-slate-300 transition-colors" onclick="hideDetailView()">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center text-lg">
                        <span class="text-slate-500 dark:text-slate-400">Class:</span>
                        <span class="font-medium">${assignment.course}</span>
                    </div>

                    <div class="flex justify-between items-center text-lg">
                        <span class="text-slate-500 dark:text-slate-400">Due Date:</span>
                        <span class="font-medium">${formatDate(assignment.dueDate)}</span>
                    </div>

                    <div class="flex justify-between items-center text-lg">
                        <span class="text-slate-500 dark:text-slate-400">Priority:</span>
                        <span class="px-3 py-1 rounded-full text-white text-sm font-medium ${priorityClass}">${assignment.priority}</span>
                    </div>
                    
                    <div class="flex justify-between items-center text-lg">
                        <span class="text-slate-500 dark:text-slate-400">Category:</span>
                        <span class="tag-pill ${tagClass}">${assignment.tag}</span>
                    </div>

                    <h3 class="text-xl font-bold pt-4">Details</h3>
                    <p class="text-slate-600 dark:text-slate-400 whitespace-pre-wrap">${assignment.description || 'No description provided.'}</p>
                    
                    <button class="w-full mt-6 px-4 py-3 text-sm font-medium rounded-lg text-white ${assignment.isCompleted ? 'bg-slate-500 hover:bg-slate-600' : 'bg-green-500 hover:bg-green-600'} transition-colors" onclick="toggleCompletion('${assignment.id}', ${!assignment.isCompleted}); hideDetailView()">
                        Mark as ${assignment.isCompleted ? 'Uncomplete' : 'Complete'}
                    </button>
                </div>
            `;
            detailModalWrapperEl.classList.remove('hidden');
        }

        function renderEditModal(assignment) {
            const dueDate = assignment.dueDate;
            
            // Helper to generate <option> tags
            const createOptions = (options, currentValue) => options.map(opt => 
                `<option value="${opt.value}" ${opt.value === currentValue ? 'selected' : ''}>${opt.label}</option>`
            ).join('');

            detailModalEl.innerHTML = `
                <form id="edit-form" class="space-y-4" onsubmit="handleEditSubmission(event, '${assignment.id}')">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-extrabold">Edit Assignment</h2>
                        <button type="button" class="text-slate-500 dark:text-slate-400 hover:text-slate-300 transition-colors" onclick="hideDetailView()">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Title</label>
                        <input id="edit-title" class="w-full bg-input-light dark:bg-input-dark border-none rounded-lg h-12 px-4 focus:ring-2 focus:ring-primary" type="text" value="${assignment.title}" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Class</label>
                        <select id="edit-class" class="w-full bg-input-light dark:bg-input-dark border-none rounded-lg h-12 px-4 focus:ring-2 focus:ring-primary">
                            ${createOptions(COURSE_OPTIONS, assignment.course)}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Due Date</label>
                        <input id="edit-due-date" class="w-full bg-input-light dark:bg-input-dark border-none rounded-lg h-12 px-4 focus:ring-2 focus:ring-primary" type="date" value="${dueDate}" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Priority</label>
                        <select id="edit-priority" class="w-full bg-input-light dark:bg-input-dark border-none rounded-lg h-12 px-4 focus:ring-2 focus:ring-primary">
                            ${createOptions(PRIORITY_OPTIONS, assignment.priority)}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Category (Tag)</label>
                        <select id="edit-tag" class="w-full bg-input-light dark:bg-input-dark border-none rounded-lg h-12 px-4 focus:ring-2 focus:ring-primary">
                            ${createOptions(TAG_OPTIONS, assignment.tag)}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="edit-description" class="w-full bg-input-light dark:bg-input-dark border-none rounded-lg p-4 focus:ring-2 focus:ring-primary" rows="4">${assignment.description || ''}</textarea>
                    </div>

                    <button type="submit" class="w-full mt-6 bg-primary text-white font-bold h-12 rounded-lg text-base tracking-wide hover:bg-blue-600 transition-colors">
                        Save Changes
                    </button>
                </form>
            `;
            detailModalWrapperEl.classList.remove('hidden');
        }

        window.showDetailView = async function(id) {
            // Find the assignment using the local or global list
            const assignment = isLocalMode 
                ? getAssignmentsFromLocal().find(a => a.id === id)
                : window.currentAssignments.find(a => a.id === id);
                
            if (!assignment) {
                console.error("Assignment not found:", id);
                return;
            }
            
            renderDetailModal(assignment);
            
            // Use location.hash for deep linking/state management
            window.location.hash = `assignment=${id}`;
        };

        window.switchToEditView = function(id) {
            const assignment = isLocalMode 
                ? getAssignmentsFromLocal().find(a => a.id === id)
                : window.currentAssignments.find(a => a.id === id);

            if (assignment) {
                renderEditModal(assignment);
            }
        };

        window.hideDetailView = function() {
            detailModalWrapperEl.classList.add('hidden');
            // Remove the hash to clear the state
            window.location.hash = '';
        };

        window.handleEditSubmission = async function(event, id) {
            event.preventDefault();
            
            const updates = {
                title: document.getElementById('edit-title').value,
                course: document.getElementById('edit-class').value,
                dueDate: document.getElementById('edit-due-date').value,
                priority: document.getElementById('edit-priority').value,
                tag: document.getElementById('edit-tag').value,
                description: document.getElementById('edit-description').value,
            };

            if (isLocalMode) {
                updateAssignmentInLocal(id, updates);
            } else {
                await updateAssignmentInFirestore(id, updates);
            }
            
            hideDetailView();
        };

        // --- Confirmation Modal Logic (Delete) ---

        let assignmentIdToDelete = null;

        window.showConfirmModal = function(id) {
            assignmentIdToDelete = id;
            const assignment = isLocalMode 
                ? getAssignmentsFromLocal().find(a => a.id === id)
                : window.currentAssignments.find(a => a.id === id);

            if (assignment) {
                document.getElementById('confirm-message').textContent = `Are you sure you want to delete "${assignment.title}"? This cannot be undone.`;
            }
            confirmModalWrapperEl.classList.remove('hidden');
        };

        window.hideConfirmModal = function() {
            confirmModalWrapperEl.classList.add('hidden');
            assignmentIdToDelete = null;
        };

        confirmDeleteBtn.onclick = async function() {
            if (!assignmentIdToDelete) return;
            
            if (isLocalMode) {
                deleteAssignmentInLocal(assignmentIdToDelete);
            } else {
                await deleteAssignmentInFirestore(assignmentIdToDelete);
            }
            
            hideConfirmModal();
            hideDetailView(); // Close the detail view if it was open
        };


        // --- Initialization and Data Listener ---

        function setupDataListener() {
            if (!isLocalMode) {
                // Database Mode
                const assignmentsCol = getAssignmentsCollection();
                if (!assignmentsCol) {
                    // This case should be rare if fallback worked, but handles auth issues
                    isLocalMode = true; // Fallback just in case
                    setupDataListener(); 
                    return; 
                }

                // Firestore Real-time listener
                const q = query(assignmentsCol);
                onSnapshot(q, (snapshot) => {
                    const assignments = [];
                    snapshot.forEach(doc => {
                        assignments.push(normalizeAssignment({ id: doc.id, ...doc.data() }));
                    });
                    window.currentAssignments = assignments; // Store globally for detail view lookups
                    renderAssignments(filterAssignments(assignments, currentFilter));
                }, (error) => {
                    console.error("Error fetching assignments from Firestore:", error);
                    // If Firestore fails during listen, we switch to local mode
                    isLocalMode = true;
                    setupDataListener();
                });
                
                connectionStatusEl.textContent = "Connected to Database (Shared)";
                connectionStatusEl.classList.remove('text-slate-500', 'bg-red-200', 'dark:bg-red-900', 'text-red-700');
                connectionStatusEl.classList.add('text-green-700', 'bg-green-200', 'dark:bg-green-900');
            } else {
                // Local Storage Mode
                const assignments = getAssignmentsFromLocal();
                window.currentAssignments = assignments;
                renderAssignments(filterAssignments(assignments, currentFilter));
                
                connectionStatusEl.textContent = "Local Mode (Browser Storage)";
                connectionStatusEl.classList.remove('text-slate-500', 'bg-green-200', 'dark:bg-green-900', 'text-green-700');
                connectionStatusEl.classList.add('text-red-700', 'bg-red-200', 'dark:bg-red-900');
            }
        }

        async function startApplication() {
            try {
                // Check if Firebase config is missing to activate Local Mode immediately
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Firebase configuration missing. Switching to Local Mode.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // If the app initializes, try to authenticate
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                isAuthReady = true;
                setupDataListener();

            } catch (error) {
                console.error("Firebase initialization failed, falling back to Local Mode:", error.message);
                isLocalMode = true;
                setupDataListener(); // Start the data listener in Local Mode
            }
        }
        
        // --- Event Listeners ---

        filterButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                // Update button styles
                filterButtons.forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white', 'hover:bg-slate-200', 'dark:hover:bg-slate-700');
                    btn.classList.add('bg-card-light', 'dark:bg-card-dark', 'text-slate-700', 'dark:text-slate-200', 'hover:bg-slate-200', 'dark:hover:bg-slate-700');
                });
                e.currentTarget.classList.remove('bg-card-light', 'dark:bg-card-dark', 'text-slate-700', 'dark:text-slate-200');
                e.currentTarget.classList.add('bg-primary', 'text-white');
                
                // Apply filter
                currentFilter = e.currentTarget.dataset.filter;
                if (window.currentAssignments) {
                    renderAssignments(filterAssignments(window.currentAssignments, currentFilter));
                }
            });
        });
        
        // Check URL hash for detail view on load
        function checkUrlForDetailView() {
            const hash = window.location.hash.substring(1);
            if (hash.startsWith('assignment=')) {
                const id = hash.split('=')[1];
                // Wait for assignments to load before trying to display detail
                const checkInterval = setInterval(() => {
                    if (window.currentAssignments) {
                        clearInterval(checkInterval);
                        showDetailView(id);
                    }
                }, 100);
            }
        }
        
        // Listen for hash changes
        window.addEventListener('hashchange', () => {
             // If hash is cleared, hide detail view (handled by hideDetailView)
             if (window.location.hash === '') {
                 // The hash change handler for the 'close' action is silent
             } else {
                 checkUrlForDetailView();
             }
        });
        
        // Start the application
        startApplication().then(() => {
            // After data is loaded, check if a detail view should be open
            checkUrlForDetailView();
        });
    </script>
</body>
</html>
